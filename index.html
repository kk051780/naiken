<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>不動産AIスイート v8.7-complete-07e (Single File)</title>
<meta name="theme-color" content="#101827" />
<style>
  :root{
    --bg:#0b1220; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --acc:#60a5fa; --ok:#34d399; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--acc)}
  .app{display:flex;flex-direction:column;height:100%;}
  header{position:sticky;top:0;z-index:9999;background:linear-gradient(180deg,#0b1220,#0b1220dd);backdrop-filter:saturate(1.2) blur(8px);}
  header .row{display:flex;align-items:center;gap:.75rem;padding:.75rem .9rem;border-bottom:1px solid #1f2937}
  .title{font-weight:700;letter-spacing:.2px}
  .badge{font-size:12px;color:#93c5fd;background:#1e293b;padding:.12rem .4rem;border-radius:.5rem;border:1px solid #334155}
  .toolbar{display:flex;gap:.5rem;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #334155;background:#0b1220;color:var(--ink);padding:.5rem .7rem;border-radius:.7rem}
  .btn:hover{border-color:#475569}
  .btn.primary{background:#1d4ed8;border-color:#3b82f6}
  .btn.ghost{background:#111827}
  .tabs{display:grid;grid-template-columns:repeat(6,1fr);border-bottom:1px solid #1f2937}
  .tab{padding:.65rem .3rem;text-align:center;cursor:pointer;border-right:1px solid #1f2937}
  .tab.active{background:#0f172a;color:#93c5fd;font-weight:600}
  main{flex:1;overflow:auto;}
  section{display:none;padding:1rem;}
  section.active{display:block}

  /* cards */
  .grid{display:grid;gap:1rem}
  @media(min-width:960px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:1rem;padding:1rem}
  .card h3{margin:.2rem 0 .6rem 0}
  .muted{color:var(--muted)}
  .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
  .row>.grow{flex:1}
  input,select,textarea{width:100%;background:#0b1220;color:var(--ink);border:1px solid #374151;border-radius:.6rem;padding:.55rem .6rem}
  textarea{min-height:120px}
  .mini{font-size:12px;color:var(--muted)}
  .pill{padding:.15rem .5rem;border:1px solid #334155;border-radius:999px}

  /* bottom actions for thumb reach */
  .dock{position:sticky;bottom:0;z-index:9998;background:linear-gradient(180deg,#0b1220cc,#0b1220);backdrop-filter:blur(10px);border-top:1px solid #1f2937;padding:.5rem}
  .dock .row{justify-content:space-between}

  /* Tap-Diag HUD */
  #tapHud{position:fixed;inset:0;pointer-events:none;background:transparent;z-index:10000}
  .hud-on{outline:2px dashed #ef4444;outline-offset:-2px}
  #toast{position:fixed;right:.8rem;bottom:5.6rem;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.7rem;z-index:10001;display:none}

  /* Chat */
  .chat{display:flex;flex-direction:column;height:100%;gap:.6rem}
  .chatlog{flex:1;overflow:auto;display:flex;flex-direction:column;gap:.5rem}
  .bubble{max-width:86%;padding:.55rem .7rem;border-radius:1rem}
  .ai{align-self:flex-start;background:#0f172a;border:1px solid #1f2937}
  .me{align-self:flex-end;background:#1f2937}
  .quick{display:flex;gap:.4rem;flex-wrap:wrap}

  /* Staging */
  #stageWrap{position:relative;min-height:260px;background:#0b1220;border:1px dashed #374151;border-radius:1rem;overflow:hidden}
  #scene{width:100%;height:100%;object-fit:contain}
  #furn{position:absolute;left:40%;top:55%;width:120px;touch-action:none;cursor:grab}

  /* Noise */
  #wave,#spec{width:100%;height:140px;background:#0b1220;border:1px solid #1f2937;border-radius:.6rem}
  #camWrap{position:relative}
  #cam{width:100%;border-radius:.6rem}
  #heat{position:absolute;inset:0;pointer-events:none}

  /* Table */
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f2937;padding:.5rem;text-align:left}
  tr.dim{opacity:.45}

  /* YT Dock */
  #ytDock{position:fixed;left:0;right:0;bottom:0;height:110px;background:#0b1220cc;backdrop-filter:blur(6px);border-top:1px solid #1f2937;display:none;z-index:9997}
  #ytDock .rail{display:flex;gap:.6rem;overflow:auto;padding:.4rem}
  .ytChip{min-width:176px;height:99px;border-radius:.5rem;overflow:hidden;border:1px solid #1f2937}

  .hide{display:none}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="row">
      <div class="title">不動産AIスイート <span class="badge">v8.7-complete-07e</span></div>
      <div class="grow"></div>
      <div class="toolbar">
        <button class="btn" id="btnHud">Tap-Diag HUD</button>
        <button class="btn" id="btnSave">保存</button>
        <button class="btn" id="btnLoad">読込</button>
      </div>
    </div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="chat">チャット</div>
      <div class="tab" data-tab="rank">ランキング</div>
      <div class="tab" data-tab="stage">ステージング</div>
      <div class="tab" data-tab="noise">騒音</div>
      <div class="tab" data-tab="inspect">内見</div>
      <div class="tab" data-tab="finance">評価/資金</div>
    </div>
  </header>

  <main>
    <!-- Chat -->
    <section id="chat" class="active">
      <div class="grid cols-2">
        <div class="card chat">
          <div class="chatlog" id="chatlog"></div>
          <div class="quick" id="quick">
            <button class="btn pill" data-cmd="駅=藤枝">駅=藤枝</button>
            <button class="btn pill" data-cmd="路≥0.8">路≥0.8</button>
            <button class="btn pill" data-cmd="徒歩≤10">徒歩≤10</button>
            <button class="btn pill" data-cmd="ランキング生成">ランキング生成</button>
          </div>
          <div class="row">
            <input id="chatInput" placeholder="メッセージ / コマンド (例: 駅=藤枝, 路≥0.85, 徒歩≤10)"/>
            <button class="btn primary" id="send">送信</button>
          </div>
        </div>
        <div class="card">
          <h3>状態</h3>
          <div id="state" class="mini"></div>
          <h3>ヒント</h3>
          <div class="mini">失敗時でも最短導線を提示（Zero Dead-End）。貼付/CSV/手入力にいつでも切替できます。</div>
        </div>
      </div>
    </section>

    <!-- Ranking -->
    <section id="rank">
      <div class="grid cols-2">
        <div class="card">
          <h3>貼付HTML → 抽出プレビュー</h3>
          <textarea id="htmlSrc" placeholder="物件一覧ページのHTMLをそのまま貼り付け"></textarea>
          <div class="row">
            <button class="btn" id="btnPreview">プレビュー</button>
            <button class="btn" id="btnApply" disabled>CSVへ反映</button>
            <span class="mini" id="extractHint"></span>
          </div>
          <div class="mini">対応：住所/価格(万)/土地面積(m²) を抽出。失敗時は汎用正規表現にフォールバック。</div>
          <div class="card" style="margin-top:.6rem">
            <h3>プレビュー</h3>
            <table id="prevTbl"><thead><tr><th>#</th><th>住所</th><th>価格(万)</th><th>土地(m²)</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h3>検索条件</h3>
          <div class="row">
            <div class="grow"><label class="mini">駅名</label><input id="station" placeholder="例: 藤枝"/></div>
            <div><label class="mini">徒歩上限(分)</label><input id="walkMax" type="number" value="10" style="width:100px"/></div>
          </div>
          <div class="row">
            <div><label class="mini">土地値比率しきい</label><input id="landRatioMin" type="number" step="0.05" value="0.8" style="width:120px"/></div>
            <div class="grow"></div>
            <button class="btn primary" id="btnRank">ランキング生成</button>
          </div>
          <div class="mini">しきい未満は薄表示。Evidenceは行クリックで展開。</div>
          <div class="card" style="margin-top:.6rem">
            <h3>ランキング</h3>
            <table id="rankTbl"><thead><tr><th>#</th><th>住所</th><th>価格(万)</th><th>V_est(万)</th><th>乖離率</th><th>土地値比率</th><th>URL</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <!-- Staging -->
    <section id="stage">
      <div class="grid cols-2">
        <div class="card">
          <h3>部屋画像</h3>
          <div id="stageWrap">
            <img id="scene" alt="scene" />
            <img id="furn" alt="furniture" />
          </div>
          <div class="row" style="margin-top:.5rem">
            <input type="file" id="roomFile" accept="image/*" capture="environment" />
            <button class="btn" id="btnResetF">家具リセット</button>
            <label class="mini">Yaw</label><input type="range" id="yaw" min="0" max="360" value="0" style="width:160px"/>
          </div>
        </div>
        <div class="card">
          <h3>自動配置 / 色温度</h3>
          <div class="row">
            <button class="btn" id="btnAutoPlace">床マスク→自動配置</button>
            <button class="btn" id="btnColor">色温度あわせ</button>
          </div>
          <div class="mini">MVP: 下部40%を床候補にし、重なり最小で配置。将来はONNX Seg / MiDaSに差し替え可能な構成。</div>
        </div>
      </div>
    </section>

    <!-- Noise -->
    <section id="noise">
      <div class="grid cols-2">
        <div class="card">
          <h3>音の可視化</h3>
          <div class="row">
            <button class="btn" id="btnMic">マイク開始</button>
            <button class="btn" id="btnStopMic">停止</button>
            <label class="mini">dBレンジ</label><input type="range" id="dbRange" min="30" max="100" value="70" style="width:160px"/>
          </div>
          <canvas id="wave"></canvas>
          <canvas id="spec" style="margin-top:.5rem"></canvas>
        </div>
        <div class="card">
          <h3>カメラ+ヒートマップ（試作）</h3>
          <div id="camWrap">
            <video id="cam" playsinline muted autoplay></video>
            <canvas id="heat"></canvas>
          </div>
          <div class="row" style="margin-top:.5rem">
            <button class="btn" id="btnCam">カメラ開始</button>
            <button class="btn" id="btnStopCam">停止</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Inspection -->
    <section id="inspect">
      <div class="grid cols-2">
        <div class="card">
          <h3>チェックガイド</h3>
          <details open>
            <summary>1. 外観</summary>
            <div class="row"><input type="file" accept="image/*,video/*" capture id="ex1"/></div>
          </details>
          <details>
            <summary>2. 玄関</summary>
            <div class="row"><input type="file" accept="image/*,video/*" capture id="ex2"/></div>
          </details>
          <details>
            <summary>3. リビング</summary>
            <div class="row"><input type="file" accept="image/*,video/*" capture id="ex3"/></div>
          </details>
          <details>
            <summary>4. キッチン</summary>
            <div class="row"><input type="file" accept="image/*,video/*" capture id="ex4"/></div>
          </details>
          <details>
            <summary>5. 水回り</summary>
            <div class="row"><input type="file" accept="image/*,video/*" capture id="ex5"/></div>
          </details>
          <details>
            <summary>6. 電気/換気</summary>
            <div class="row"><input type="file" accept="image/*,video/*" capture id="ex6"/></div>
          </details>
          <details>
            <summary>7. 建付/結露</summary>
            <div class="row"><input type="file" accept="image/*,video/*" capture id="ex7"/></div>
          </details>
          <details>
            <summary>8. 総括</summary>
            <div class="row"><textarea id="sum"></textarea></div>
          </details>
        </div>
        <div class="card">
          <h3>レポート</h3>
          <div class="row">
            <button class="btn" id="btnPrint">PDF/印刷</button>
            <button class="btn" id="btnClear">クリア</button>
          </div>
          <div class="mini">印刷はブラウザのPDF出力を利用（端末内）。</div>
        </div>
      </div>
    </section>

    <!-- Finance/AVM -->
    <section id="finance">
      <div class="grid cols-2">
        <div class="card">
          <h3>AI査定（MVP）</h3>
          <div class="row">
            <div class="grow"><label class="mini">住所</label><input id="addr" placeholder="例: 静岡県藤枝市…"/></div>
          </div>
          <div class="row">
            <div><label class="mini">土地(m²)</label><input type="number" id="land"/></div>
            <div><label class="mini">延床(m²)</label><input type="number" id="floor"/></div>
            <div><label class="mini">築年</label><input type="number" id="age"/></div>
            <div><label class="mini">構造</label>
              <select id="struct">
                <option>木造</option><option>S造</option><option>RC</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label class="mini">路線価(千円/m²)</label><input type="number" id="rosen"/></div>
            <div><label class="mini">近傍成約 avg(万/m²)</label><input type="number" id="dealAvg"/></div>
            <div class="grow"></div>
            <button class="btn primary" id="btnAVM">査定</button>
          </div>
          <div id="avmOut"></div>
        </div>
        <div class="card">
          <h3>DSCR</h3>
          <div class="row">
            <div><label class="mini">家賃(万/月)</label><input type="number" id="rent"/></div>
            <div><label class="mini">空室率(%)</label><input type="number" id="vac" value="5"/></div>
            <div><label class="mini">経費率(%)</label><input type="number" id="opex" value="20"/></div>
          </div>
          <div class="row">
            <div><label class="mini">借入(万円)</label><input type="number" id="debt"/></div>
            <div><label class="mini">金利(%)</label><input type="number" id="rate" value="2.0"/></div>
            <div><label class="mini">年数</label><input type="number" id="years" value="25"/></div>
            <div class="grow"></div>
            <button class="btn" id="btnDSCR">計算</button>
          </div>
          <div id="dscrOut"></div>
        </div>
      </div>
    </section>
  </main>

  <div class="dock">
    <div class="row">
      <div class="mini">HUD/保存はここから。サムネ・ドックは右のトグルで表示。</div>
      <div class="row">
        <button class="btn ghost" id="toggleDock">動画ドック</button>
        <button class="btn" id="btnVideos">YouTube取得</button>
      </div>
    </div>
  </div>
</div>

<!-- Tap HUD Canvas -->
<canvas id="tapHud"></canvas>
<div id="toast"></div>
<div id="ytDock"><div class="rail" id="ytRail"></div></div>

<script>
const S = {
  ver: 'v8.7-complete-07e',
  state: { station:null, walkMax:10, landRatioMin:0.8, htmlItems:[], csv:[], samples:[], mab:{} },
  storageKey: 're-app-87e',
};

/* ---------- Helpers ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function toast(msg, ms=1800){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); }
function save(){ localStorage.setItem(S.storageKey, JSON.stringify(S.state)); toast('保存しました'); }
function load(){ const s=localStorage.getItem(S.storageKey); if(s){ S.state=Object.assign(S.state, JSON.parse(s)); renderState(); toast('読込完了'); } }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

/* ---------- Tabs ---------- */
$('#tabs').addEventListener('click', e=>{ const t=e.target.closest('.tab'); if(!t) return; $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); $$('main>section').forEach(x=>x.classList.remove('active')); $('#'+t.dataset.tab).classList.add('active'); });

$('#btnSave').onclick = save; $('#btnLoad').onclick = load;

/* ---------- Tap-Diag HUD ---------- */
let hudOn=false; const hud=$('#tapHud'); const hctx=hud.getContext('2d');
function resizeHud(){ hud.width=innerWidth; hud.height=innerHeight; }
resizeHud(); addEventListener('resize', resizeHud);
function drawHud(){ hctx.clearRect(0,0,hud.width,hud.height); const els=[...document.querySelectorAll('*')].filter(el=>{
  const st=getComputedStyle(el); if(st.display==='none' || st.visibility==='hidden') return false; const r=el.getBoundingClientRect();
  return r.width>40&&r.height>28 && st.position!=='static' && st['z-index']!=='auto' && st.pointerEvents!=='none';
}); els.forEach(el=>{ const r=el.getBoundingClientRect(); hctx.strokeStyle='rgba(239,68,68,.8)'; hctx.lineWidth=2; hctx.strokeRect(r.left,r.top,r.width,r.height); }); }
$('#btnHud').onclick=()=>{ hudOn=!hudOn; hud.style.display=hudOn?'block':'none'; if(hudOn){ drawHud(); toast('HUD: オン'); } else toast('HUD: オフ'); };

document.addEventListener('click', (e)=>{ if(!hudOn) return; drawHud(); });

/* ---------- Chat ---------- */
const chatlog=$('#chatlog'); function addBubble(t,who='ai'){ const b=document.createElement('div'); b.className='bubble '+who; b.textContent=t; chatlog.appendChild(b); chatlog.scrollTop=chatlog.scrollHeight; }
function renderState(){ $('#state').textContent = JSON.stringify({station:S.state.station,walkMax:S.state.walkMax,landRatioMin:S.state.landRatioMin},null,2); }
function applyCmd(cmd){ try{
  if(/^駅=/.test(cmd)){ S.state.station = cmd.split('=')[1]; addBubble(`駅を「${S.state.station}」に設定しました。`,'ai'); }
  else if(/^路≥/.test(cmd)){ S.state.landRatioMin = parseFloat(cmd.replace('路≥','')); addBubble(`土地値比率の下限を ${S.state.landRatioMin} に設定。`,'ai'); }
  else if(/^徒歩≤/.test(cmd)){ S.state.walkMax = parseInt(cmd.replace('徒歩≤','')); addBubble(`徒歩上限を ${S.state.walkMax} 分に設定。`,'ai'); }
  else if(/ランキング生成/.test(cmd)){ doRanking(); }
  else { addBubble('コマンドが解釈できませんでした。例: 駅=藤枝, 路≥0.85, 徒歩≤10, ランキング生成','ai'); }
  renderState();
} catch(err){ addBubble('内部処理で例外が発生。状態は維持し、復帰手順を提示します: ①貼付→②プレビュー→③CSV反映→ランキング生成','ai'); console.error(err); }
}
$('#send').onclick=()=>{ const v=$('#chatInput').value.trim(); if(!v) return; addBubble(v,'me'); $('#chatInput').value=''; applyCmd(v); };
$('#quick').addEventListener('click',(e)=>{ const b=e.target.closest('button[data-cmd]'); if(!b) return; addBubble(b.dataset.cmd,'me'); applyCmd(b.dataset.cmd); });
addBubble('ようこそ。貼付→プレビュー→反映→ランキング生成の順で進められます。コマンド例: 「駅=藤枝」「路≥0.85」「徒歩≤10」','ai');
renderState();

/* ---------- Ranking: Extract from HTML ---------- */
const prevBody = $('#prevTbl tbody'); const rankBody=$('#rankTbl tbody');
$('#btnPreview').onclick=()=>{
  const html=$('#htmlSrc').value; prevBody.innerHTML=''; let rows=[]; let hint='';
  try{
    const doc=new DOMParser().parseFromString(html,'text/html');
    const items=[...doc.querySelectorAll('a,article,li,div,section')];
    for(const it of items){
      const t=it.textContent.replace(/\s+/g,' ');
      const addr=(t.match(/(都|道|府|県).+?市.+?(区|町|村|[0-9\-−丁目]+)/) || t.match(/[\u4e00-\u9faf].{4,20}(市|区|町|村).{0,20}/))?.[0];
      const price=(t.match(/([0-9,.]+)\s*万/)||[])[1];
      const land=(t.match(/(土地|敷地).*?([0-9,.]+)\s*m²/i)||t.match(/([0-9,.]+)\s*m²/))?.[2]||t.match(/([0-9,.]+)\s*m²/)?.[1];
      if(addr && (price||land)) rows.push({address:addr, priceMan: price? parseFloat(price.replace(/,/g,'')) : null, landArea: land? parseFloat(land.replace(/,/g,'')) : null, url: it.closest('a')?.href || '#' });
      if(rows.length>=30) break;
    }
    if(rows.length===0){
      // Fallback regex over whole HTML
      const re=/(静岡|東京|神奈川|埼玉|千葉|大阪|愛知)[^<]{0,60}(市|区|郡|町|村)[^<]{0,60}/g; let m; while((m=re.exec(html))){ const addr=m[0]; const p=(html.slice(m.index,m.index+180).match(/([0-9,.]+)\s*万/)||[])[1]; const a=(html.slice(m.index,m.index+320).match(/([0-9,.]+)\s*m²/)||[])[1]; if(addr&&(p||a)) rows.push({address:addr,priceMan:p?parseFloat(p.replace(/,/g,'')):null, landArea:a?parseFloat(a.replace(/,/g,'')):null, url:'#'}); if(rows.length>=20)break; }
      hint='汎用正規表現で抽出しました。ドメイン固有ルールの追加を推奨。';
    }
  }catch(e){ console.error(e); hint='HTMLパースに失敗。貼付内容を確認してください。'; }
  $('#extractHint').textContent = `抽出 ${rows.length} 件。${hint}`;
  rows.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${r.address||''}</td><td>${r.priceMan??''}</td><td>${r.landArea??''}</td>`; prevBody.appendChild(tr); });
  S.state.samples = rows; $('#btnApply').disabled = rows.length===0; };

$('#btnApply').onclick=()=>{ S.state.csv.push(...S.state.samples); S.state.samples=[]