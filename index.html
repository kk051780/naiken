<!DOCTYPE html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>内見アプリ（フルv6.0）</title>
<style>
:root{--bg:#0e1726;--panel:#162135;--panel2:#0f1a2b;--accent:#4cc9f0;--good:#52d273;--bad:#ff6b6b;--text:#e6edf3;--muted:#a8b4c5}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',Hiragino Sans,Yu Gothic,sans-serif}
a{color:var(--accent)}
h1{font-size:18px;margin:12px 16px}
.tabs{display:flex;flex-wrap:wrap;gap:8px;padding:10px 12px;position:sticky;top:0;z-index:9;background:linear-gradient(0deg,rgba(14,23,38,.6),rgba(14,23,38,1));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
.tabbtn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:var(--panel);color:var(--text);font-weight:600}
.tabbtn.on{background:var(--accent);color:#001018;border-color:transparent}
.section{display:none;padding:12px}
.section.on{display:block}
.card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin:10px 0}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
button,input,select,textarea{background:var(--panel2);color:var(--text);border:1px solid rgba(255,255,255,.1);padding:10px 12px;border-radius:10px;font-size:14px}
button.primary{background:var(--accent);color:#04151a;border:0}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0004;border:1px solid rgba(255,255,255,.15);color:var(--muted);font-size:12px}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media(min-width:920px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
.full{width:100%}
.small{width:110px}
.mid{width:160px}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
.note{font-size:12px;color:var(--muted)}
.stageWrap{position:relative;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden;background:#000;min-height:48vh}
#stage,#video{display:none;width:100%}
#ov{position:absolute;inset:0;touch-action:none}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111a;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.2);opacity:0;color:#fff}
.toast.show{opacity:1}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .pill{background:#0004;border:1px solid rgba(255,255,255,.12);padding:8px 10px;border-radius:10px}
hr.sep{border:0;border-top:1px dashed rgba(255,255,255,.15);margin:12px 0}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,.1);padding:6px 8px;text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
</style></head>
<body>
<h1>不動産 内見・ステージング・計測・騒音・収支・チェック（フルv6.0）</h1>
<div class="tabs">
  <button id="tab-stage" class="tabbtn on" onclick="setTab('stage')">ステージング</button>
  <button id="tab-noise" class="tabbtn" onclick="setTab('noise')">騒音</button>
  <button id="tab-area"  class="tabbtn" onclick="setTab('area')">間取り・実寸</button>
  <button id="tab-prop"  class="tabbtn" onclick="setTab('prop')">物件情報/土地値比率</button>
  <button id="tab-dscr"  class="tabbtn" onclick="setTab('dscr')">収支/DSCR</button>
  <button id="tab-chk"   class="tabbtn" onclick="setTab('chk')">チェック</button>
  <button id="tab-save"  class="tabbtn" onclick="setTab('save')">保存/レポート</button>
</div>

<div id="toast" class="toast"></div>

<section id="sec-stage" class="section on">
  <div class="card row">
    <button id="btnCam">カメラ起動</button>
    <button id="btnShot">撮影</button>
    <input id="picker" type="file" accept="image/*" style="display:none">
    <button id="btnPick">写真を選ぶ</button>
    <button id="btnDemo">デモ画像</button>
    <label>デジタルズーム <input id="zoom" class="small" type="range" min="1" max="1.8" step="0.02" value="1"></label>
  </div>
  <div class="stageWrap" id="wrap">
    <img id="stage" alt="preview">
    <video id="video" playsinline></video>
    <canvas id="ov"></canvas>
  </div>
  <div class="card row">
    <select id="btnStyle">
      <option>スタイルを選択（デモ）</option>
      <option>単身男性 / ミニマル</option>
      <option>ナチュラル</option>
      <option>北欧</option>
      <option>モダン</option>
    </select>
    <button id="btnAuto" class="primary">自動配置</button>
    <button id="btnReset">家具リセット</button>
    <button id="btnBase">基準2点</button>
    <label>基準長さ(m)<input id="refLen" type="number" class="small" step="0.01" value="2.0"></label>
    <span id="scLabel" class="badge">スケール未設定</span>
  </div>
</section>

<section id="sec-noise" class="section">
  <div class="card row">
    <button id="btnMic" class="primary">マイク計測開始</button>
    <button id="btnMicStop">停止</button>
    <span class="note">※端末の権限が必要です。値は簡易SPL（相対値）です。</span>
  </div>
  <div class="card">
    <div class="kpi"><div class="pill" id="noiseStats">-</div><div class="pill">LAeq相当(簡易)：平均</div></div>
    <canvas id="time" style="width:100%;height:140px"></canvas>
  </div>
  <div class="card">
    <div class="note">FFTスペクトログラム（時系列）</div>
    <canvas id="spec" style="width:100%;height:180px;background:#000"></canvas>
  </div>
</section>

<section id="sec-area" class="section">
  <div class="card grid">
    <div class="kv"><div>部屋幅W(m)</div><input id="roomW" type="number" step="0.01" value="3.6"></div>
    <div class="kv"><div>奥行D(m)</div><input id="roomD" type="number" step="0.01" value="2.7"></div>
    <div class="kv"><div>単価(円/m²)</div><input id="unit" type="number" value="1200"></div>
    <button id="btnAreaAdd" class="primary">追加</button>
    <button id="btnAreaReset">リセット</button>
  </div>
  <div class="card">
    <table id="areaTbl" class="table">
      <thead><tr><th>#</th><th>W</th><th>D</th><th>面積</th><th>単価</th><th>概算</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><th colspan="3">合計</th><th id="areaTotal">0</th><th></th><th id="costTotal">0</th></tr></tfoot>
    </table>
  </div>
</section>

<section id="sec-prop" class="section">
  <div class="card grid">
    <div class="kv"><div>物件価格(万円)</div><input id="price" type="number" placeholder="例: 1980"></div>
    <div class="kv"><div>土地面積(m²)</div><input id="landArea" type="number" placeholder="例: 100"></div>
    <div class="kv"><div>住所（任意）</div><input id="addr" type="text" placeholder="静岡県藤枝市..."></div>
    <div class="kv"><div>GPS座標</div><div class="row"><input id="lat" class="mid" placeholder="緯度"> <input id="lng" class="mid" placeholder="経度"> <button id="btnGPS">GPSで取得</button></div></div>
  </div>
  <div class="card grid">
    <div class="kv"><div>路線価(千円/m²)</div><input id="rosen" type="number"></div>
    <div class="kv"><div>公示価格(千円/m²)</div><input id="koushi" type="number"></div>
    <div class="kv"><div>近傍成約(千円/m²)</div><input id="near" type="number"></div>
    <button id="btnLandAvg" class="primary">3点平均を計算</button>
    <div class="kv"><div>3点平均(千円/m²)</div><input id="landAvg" type="number" readonly></div>
  </div>
  <div class="card">
    <div class="kv"><div>土地値比率</div><div id="ratio" class="badge"></div></div>
    <div class="note">※自動取得はブラウザのCORS制限のため不可の場合があります。値を入力して算出してください。</div>
  </div>
</section>

<section id="sec-dscr" class="section">
  <div class="card grid">
    <div class="kv"><div>月額家賃(円)</div><input id="rent" type="number" value="70000"></div>
    <div class="kv"><div>稼働率</div><input id="occ" type="number" step="0.01" value="0.95"></div>
    <div class="kv"><div>経費率</div><input id="expRate" type="number" step="0.01" value="0.20"></div>
    <div class="kv"><div>築年数プリセット</div>
      <select id="expPreset">
        <option value="~5">~5年(15%)</option>
        <option value="6-15" selected>6-15年(20%)</option>
        <option value="16-30">16-30年(25%)</option>
        <option value="31+">31年以上(30%)</option>
      </select></div>
    <div class="kv"><div>固定費(年,円)</div><input id="fixed" type="number" value="120000"></div>
  </div>
  <div class="card grid">
    <div class="kv"><div>借入額(年,円)</div><input id="loan" type="number" value="15000000"></div>
    <div class="kv"><div>年利(小数)</div><input id="rate" type="number" step="0.001" value="0.02"></div>
    <div class="kv"><div>返済年数</div><input id="years" type="number" value="30"></div>
  </div>
  <div class="card kpi">
    <div class="pill">NOI: <span id="noi">-</span></div>
    <div class="pill">年返済: <span id="pay">-</span></div>
    <div class="pill">DSCR: <span id="dscr">-</span> <b id="dscrVerdict"></b></div>
  </div>
</section>

<section id="sec-chk" class="section">
  <div class="card note">各項目の数量を入力すると概算修繕費を計算します。写真/動画の記録はステージング/カメラで撮影し、レポートに添付してください。</div>
  <div class="card">
    <table class="table">
      <thead><tr><th>項目</th><th>判定</th><th>数量</th><th>単位</th><th>単価</th><th>概算</th></tr></thead>
      <tbody id="chkBody"></tbody>
      <tfoot><tr><th colspan="5">合計</th><th id="chkTotal">0</th></tr></tfoot>
    </table>
  </div>
</section>

<section id="sec-save" class="section">
  <div class="card row">
    <button id="btnSaveReport" class="primary">レポートHTMLを保存</button>
    <button id="btnSaveJSON">状態(JSON)を保存</button>
    <input id="btnLoadJSON" type="file" accept="application/json">
  </div>
  <div class="card note">
    GitHub Pages / ローカルでも動作するよう、外部API依存を避けた設計です。<br>
    将来、生成画像の家具やポータル自動抽出を追加する場合は、別タブのサーバレス関数/プロキシを用意する方針が安全です。
  </div>
</section>

<div id="toast" class="toast"></div>
<script>
const $=s=>document.querySelector(s);const $$=s=>document.querySelectorAll(s);
const toast=msg=>{const t=$('#toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400)};
function setTab(id){$$('.section').forEach(x=>x.classList.remove('on'));$(`#sec-${id}`).classList.add('on');$$('.tabbtn').forEach(x=>x.classList.remove('on'));$(`#tab-${id}`).classList.add('on')}
window.addEventListener('hashchange',()=>{const id=location.hash.replace('#','')||'stage';setTab(id);});
document.addEventListener('DOMContentLoaded',()=>{setTab((location.hash||'#stage').slice(1))});

/* ===== カメラ & ステージング ===== */
const wrap = document.getElementById('wrap'), stage = document.getElementById('stage'), video = document.getElementById('video'), ov=document.getElementById('ov'), ctx=ov.getContext('2d');
let items=[], dragging=null, dragOff={x:0,y:0}, baseline=[], scale=null, zoom=1, mode='drag';
function fitCanvas(){const r=wrap.getBoundingClientRect(), dpr=window.devicePixelRatio||1; ov.style.width=r.width+'px';ov.style.height=r.height+'px';ov.width=r.width*dpr;ov.height=r.height*dpr;ctx.setTransform(dpr,0,0,dpr,0,0); redraw();}
window.addEventListener('resize',fitCanvas);
function redraw(){ctx.clearRect(0,0,ov.width,ov.height); items.forEach(drawItem); if(baseline.length){ctx.lineWidth=2;ctx.strokeStyle='#ffcc00';ctx.fillStyle='#ffcc00';ctx.beginPath();ctx.arc(baseline[0].x,baseline[0].y,5,0,7);ctx.fill(); if(baseline.length>1){ctx.beginPath();ctx.moveTo(baseline[0].x,baseline[0].y);ctx.lineTo(baseline[1].x,baseline[1].y);ctx.stroke();ctx.beginPath();ctx.arc(baseline[1].x,baseline[1].y,5,0,7);ctx.fill();}} }
function drawItem(it){ctx.save();ctx.shadowColor='rgba(0,0,0,.4)';ctx.shadowBlur=8;ctx.globalAlpha=.92;ctx.fillStyle=it.color;ctx.fillRect(it.x,it.y,it.w,it.h);ctx.globalAlpha=1;ctx.lineWidth=3;ctx.strokeStyle='#fff';ctx.strokeRect(it.x,it.y,it.w,it.h);ctx.fillStyle='#fff';ctx.font='bold 14px system-ui';ctx.fillText(it.label,it.x+8,it.y+18);ctx.restore();}
function clamp(it){const r=ov.getBoundingClientRect();it.x=Math.max(0,Math.min(it.x,r.width-it.w));it.y=Math.max(0,Math.min(it.y,r.height-it.h));}
function pt(ev){const r=ov.getBoundingClientRect();return {x:ev.clientX-r.left,y:ev.clientY-r.top}}

document.getElementById('btnCam').onclick=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});video.srcObject=s;video.style.display='block';stage.style.display='none';await video.play();fitCanvas();toast('カメラ起動');}catch(e){alert('カメラ失敗: '+e.message);}}
document.getElementById('btnShot').onclick=()=>{if(!video.srcObject){toast('カメラ未起動');return}const c=document.createElement('canvas');c.width=video.videoWidth;c.height=video.videoHeight;c.getContext('2d').drawImage(video,0,0);stage.src=c.toDataURL('image/jpeg',0.92);stage.style.display='block';if(video.srcObject){video.srcObject.getTracks().forEach(t=>t.stop());video.srcObject=null;}video.style.display='none';fitCanvas();}
document.getElementById('btnPick').onclick=()=>document.getElementById('picker').click();
document.getElementById('picker').onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{stage.src=r.result;stage.style.display='block';video.style.display='none';if(video.srcObject)video.srcObject.getTracks().forEach(t=>t.stop());items=[];baseline=[];scale=null;fitCanvas();};r.readAsDataURL(f)}
document.getElementById('btnDemo').onclick=()=>{stage.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA1AAAAEACAYAAAB3xv5SAAAACXBIWXMAAAsSAAALEgHS3X78AAAAGXRFWHRTb2Z0d2FyZQBwYWludC5uZXQgNC4xLjZ5M8QAAABZSURBVHic7cEBAQAAAIIg/69uSEABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPgGJ+QAAaeN8mEAAAAASUVORK5CYII=';stage.style.display='block';video.style.display='none';items=[];baseline=[];scale=null;fitCanvas();}

document.getElementById('zoom').oninput=e=>{zoom=parseFloat(e.target.value);stage.style.transform=`scale(${zoom})`;stage.style.transformOrigin='center center';};

document.getElementById('btnAuto').onclick=()=>{const r=ov.getBoundingClientRect(),W=r.width,H=r.height,m=20;const pal=['#3b76f6','#8d5b2d','#2f7a3f','#a24992'];function mk(lbl,w,h,x,y,i){const it={label:lbl,w,h,x,y,color:pal[i%pal.length]};clamp(it);return it}const fw=Math.max(120,W*0.28),fh=Math.max(90,H*0.18);items=[mk('ソファ',fw,fh,m,H-fh-m,0),mk('テーブル',fw*.7,fh*.7,W/2-fw*.35,H-fh*.9-m,1),mk('観葉',fw*.5,fh*.9,W-fw*.5-m,H-fh*.9-m,2)];redraw();toast('自動配置完了');}
document.getElementById('btnStyle').onchange=e=>{toast('スタイル: '+e.target.value);};
document.getElementById('btnBase').onclick=()=>{if(mode==='base'){if(baseline.length===2){const dx=baseline[0].x-baseline[1].x,dy=baseline[0].y-baseline[1].y;const px=Math.hypot(dx,dy);const ref=parseFloat(document.getElementById('refLen').value||'0');if(px>0&&ref>0){scale=ref/px;document.getElementById('scLabel').textContent='スケール: '+scale.toFixed(4)+' m/px';toast('スケール設定');}}mode='drag';document.getElementById('btnBase').textContent='基準2点';}else{baseline=[];mode='base';document.getElementById('btnBase').textContent='確定（基準2点）';toast('画像上で2点タップ');}redraw();};
document.getElementById('btnReset').onclick=()=>{items=[];redraw();};

ov.addEventListener('pointerdown',ev=>{const p=pt(ev); if(mode==='base'){baseline.push(p); if(baseline.length>2)baseline.shift();redraw();return} for(let i=items.length-1;i>=0;i--){const it=items[i]; if(p.x>=it.x&&p.x<=it.x+it.w&&p.y>=it.y&&p.y<=it.y+it.h){dragging=it;dragOff.x=p.x-it.x;dragOff.y=p.y-it.y;ov.setPointerCapture(ev.pointerId);break}}});
ov.addEventListener('pointermove',ev=>{if(!dragging||mode!=='drag')return;const p=pt(ev);dragging.x=p.x-dragOff.x;dragging.y=p.y-dragOff.y;clamp(dragging);redraw();});
ov.addEventListener('pointerup',ev=>{if(dragging){dragging=null;ov.releasePointerCapture(ev.pointerId)}});
stage.onload=fitCanvas;

/* ===== 騒音（RMS + FFTスペクトログラム） ===== */
let audioCtx, analyser, micSrc, dataTime=[], tStart=null, rafId=null;
const timeCanvas=document.getElementById('time'), tctx=timeCanvas.getContext('2d');
const specCanvas=document.getElementById('spec'), sctx=specCanvas.getContext('2d');
function sizeNoiseCanvas(){const dpr=window.devicePixelRatio||1;[timeCanvas,specCanvas].forEach(c=>{c.width=c.clientWidth*dpr;c.height=c.clientHeight*dpr;});tctx.setTransform(dpr,0,0,dpr,0,0);sctx.setTransform(dpr,0,0,dpr,0,0);}
window.addEventListener('resize',sizeNoiseCanvas); sizeNoiseCanvas();

document.getElementById('btnMic').onclick=async()=>{try{audioCtx=new (window.AudioContext||window.webkitAudioContext)();const stream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});micSrc=audioCtx.createMediaStreamSource(stream);analyser=audioCtx.createAnalyser();analyser.fftSize=1024;micSrc.connect(analyser);dataTime=[];tStart=performance.now();loopNoise();toast('マイク計測中');}catch(e){alert('マイク失敗: '+e.message);}}
document.getElementById('btnMicStop').onclick=()=>{if(audioCtx)audioCtx.close();cancelAnimationFrame(rafId);};

function loopNoise(){const buf=new Uint8Array(analyser.fftSize);const freq=new Uint8Array(analyser.frequencyBinCount);const now=performance.now();analyser.getByteTimeDomainData(buf);analyser.getByteFrequencyData(freq); // RMS→擬似dB
  let sum=0;for(let i=0;i<buf.length;i++){const v=(buf[i]-128)/128;sum+=v*v}const rms=Math.sqrt(sum/buf.length);const db=20*Math.log10(rms+1e-6)+100; // 0~100程度
  dataTime.push({t:(now-tStart)/1000,db}); if(dataTime.length>500)dataTime.shift();
  drawTime(); drawSpec(freq); rafId=requestAnimationFrame(loopNoise);
}
function drawTime(){const W=timeCanvas.clientWidth,H=timeCanvas.clientHeight;tctx.clearRect(0,0,W,H);tctx.strokeStyle='#7cc5ff';tctx.beginPath();const maxT=(dataTime.at(-1)?.t||0);const start=Math.max(0,maxT-20);dataTime.forEach((p,i)=>{const x=(p.t-start)/20*W;const y=H-(p.db/120)*H;tctx[i?'lineTo':'moveTo'](x,y);});tctx.stroke(); // stats
 const d=dataTime.map(p=>p.db);const min=Math.min(...d),max=Math.max(...d),avg=d.reduce((a,b)=>a+b,0)/d.length||0;document.getElementById('noiseStats').textContent=`最小:${min.toFixed(1)}  最大:${max.toFixed(1)}  平均:${avg.toFixed(1)}`;}
function drawSpec(freq){const W=specCanvas.clientWidth,H=specCanvas.clientHeight;const col=t=>`hsl(${200-160*t},70%,60%)`; // map
  const x=W-1; // shift left
  const img=sctx.getImageData(1,0,W-1,H); sctx.putImageData(img,0,0);
  for(let y=0;y<H;y++){const idx=Math.floor(y/H*freq.length);const v=freq[idx]/255; sctx.fillStyle=col(v); sctx.fillRect(W-1,H-1-y,1,1);}
}

/* ===== 間取り/実寸（簡易） ===== */
document.getElementById('btnAreaAdd').onclick=()=>{const w=parseFloat(document.getElementById('roomW').value||0);const d=parseFloat(document.getElementById('roomD').value||0);const unit=parseFloat(document.getElementById('unit').value||0);const a=w*d;const cost=a*unit;const tbody=document.querySelector('#areaTbl tbody');const tr=document.createElement('tr');tr.innerHTML=`<td>${tbody.children.length+1}</td><td>${w.toFixed(2)}</td><td>${d.toFixed(2)}</td><td>${a.toFixed(2)}</td><td>${unit.toLocaleString()}</td><td>${Math.round(cost).toLocaleString()}</td>`;tbody.appendChild(tr);updateTotals();};
document.getElementById('btnAreaReset').onclick=()=>{document.querySelector('#areaTbl tbody').innerHTML='';updateTotals();};
function updateTotals(){let a=0,c=0;document.querySelectorAll('#areaTbl tbody tr').forEach(tr=>{a+=parseFloat(tr.children[3].textContent);c+=parseFloat(tr.children[5].textContent.replace(/,/g,''));});document.getElementById('areaTotal').textContent=a.toFixed(2);document.getElementById('costTotal').textContent=Math.round(c).toLocaleString();}

/* ===== 物件情報/土地値比率 ===== */
document.getElementById('btnGPS').onclick=()=>{if(!navigator.geolocation){alert('Geolocation未対応');return}navigator.geolocation.getCurrentPosition(pos=>{document.getElementById('lat').value=pos.coords.latitude.toFixed(6);document.getElementById('lng').value=pos.coords.longitude.toFixed(6);toast('座標取得') },err=>alert('GPS失敗: '+err.message));};
document.getElementById('btnLandAvg').onclick=()=>{const r=parseFloat(document.getElementById('rosen').value||0);const k=parseFloat(document.getElementById('koushi').value||0);const n=parseFloat(document.getElementById('near').value||0);const avg=(r+k+n)/3;document.getElementById('landAvg').value=avg?avg.toFixed(0):'';calcLandRatio();};
function calcLandRatio(){const price=parseFloat(document.getElementById('price').value||0)*10000;const landAvg=parseFloat(document.getElementById('landAvg').value||0);const landArea=parseFloat(document.getElementById('landArea').value||0);const landVal=landAvg*landArea*1000; // 千円/m2仮定
 const ratio= price? (landVal/price*100):0;document.getElementById('ratio').textContent= price? ratio.toFixed(1)+'%':'';}
['price','landAvg','landArea'].forEach(id=>document.getElementById(id).addEventListener('input',calcLandRatio));

/* ===== 収支/DSCR ===== */
const presets={'~5':0.15,'6-15':0.20,'16-30':0.25,'31+':0.30};
document.getElementById('expPreset').onchange=e=>{document.getElementById('expRate').value=presets[e.target.value];calcDSCR();};
['rent','occ','expRate','fixed','loan','rate','years'].forEach(id=>document.getElementById(id).addEventListener('input',calcDSCR));
function pmt(rate, nper, pv){ // yearly
 const r=rate;return r===0? pv/nper : (pv*r)/(1-Math.pow(1+r,-nper));}
function calcDSCR(){const rent= parseFloat($('#rent').value||0)*12;const occ=parseFloat($('#occ').value||0);const eff=rent*occ;const expRate=parseFloat($('#expRate').value||0);const opex=eff*expRate + parseFloat($('#fixed').value||0);const noi=eff-opex;const loan=parseFloat($('#loan').value||0);const rate=parseFloat($('#rate').value||0);const years=parseFloat($('#years').value||0);const pay= pmt(rate,years,loan);const dscr= pay? noi/pay : 0; $('#noi').textContent=Math.round(noi).toLocaleString();$('#pay').textContent=Math.round(pay).toLocaleString();$('#dscr').textContent=dscr.toFixed(2); const verdict= dscr>=1.2? '有利（目安クリア）':'要検討（余裕不足）';$('#dscrVerdict').textContent=verdict;$('#dscrVerdict').style.color= dscr>=1.2?'var(--good)':'var(--bad)';}
calcDSCR();

/* ===== チェックモード（簡易） ===== */
const checklist=[
 ['外壁・屋根雨漏り',50000,'箇所'],
 ['室内壁/天井（汚れ/剥がれ/カビ）',1500,'m²'],
 ['床（傷/沈み/床鳴り）',8000,'m²'],
 ['水回り（キッチン/浴室/洗面/トイレ）',30000,'式'],
 ['建具/サッシ/鍵',10000,'箇所'],
 ['電気/配線/分電盤',20000,'式'],
 ['給湯/空調',30000,'式']
];
const tbodyC=$('#chkBody');
checklist.forEach(row=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${row[0]}</td><td><select><option>良</option><option>注意</option><option>要修繕</option></select></td><td><input type='number' class='small' value='0'></td><td class='unit'>${row[2]}</td><td class='unitp'>${row[1]}</td><td class='sum'>0</td>`;tbodyC.appendChild(tr);});
function updChk(){let total=0;tbodyC.querySelectorAll('tr').forEach(tr=>{const qty=parseFloat(tr.querySelector('input').value||0);const unit=parseFloat(tr.querySelector('.unitp').textContent);const s=qty*unit;tr.querySelector('.sum').textContent=Math.round(s).toLocaleString();total+=s;});$('#chkTotal').textContent=Math.round(total).toLocaleString();}
tbodyC.addEventListener('input',updChk);updChk();

/* ===== レポート保存（HTML） & JSON ===== */
document.getElementById('btnSaveReport').onclick=()=>{const html=`<html><meta charset='utf-8'><title>内見レポート</title><body><h2>内見レポート</h2>
  <h3>物件情報</h3>
  価格: ${$('#price').value} 万円 / 土地値比率: ${$('#ratio').textContent}<br>
  3点平均(千円/m²): ${$('#landAvg').value} / 土地面積(m²): ${$('#landArea').value}<hr>
  <h3>収支/DSCR</h3>
  NOI: ${$('#noi').textContent} / 年返済: ${$('#pay').textContent} / DSCR: ${$('#dscr').textContent} (${$('#dscrVerdict').textContent})<hr>
  <h3>チェック結果 概算修繕費</h3>
  合計: ${$('#chkTotal').textContent} 円
</body></html>`;const blob=new Blob([html],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='report.html';a.click();};

document.getElementById('btnSaveJSON').onclick=()=>{const data={price:$('#price').value,landAvg:$('#landAvg').value,landArea:$('#landArea').value,room:$('#areaTbl').innerHTML,chk:$('#chkBody').innerHTML};const blob=new Blob([JSON.stringify(data)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='project.json';a.click();};
document.getElementById('btnLoadJSON').onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const d=JSON.parse(r.result);$('#price').value=d.price||'';$('#landAvg').value=d.landAvg||'';$('#landArea').value=d.landArea||'';$('#areaTbl').innerHTML=d.room||$('#areaTbl').innerHTML;$('#chkBody').innerHTML=d.chk||$('#chkBody').innerHTML;calcLandRatio();updChk();}catch(err){alert('読込失敗:'+err.message)}};r.readAsText(f);};
</script>
</body></html>