<!doctype html><html lang="ja"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>内見ユーティリティ（v7.4.2 クリック貫通ホットフィックス）</title>
<style>
:root{--bg:#0f1928;--panel:#10243d;--ink:#e9f3ff;--mut:#9ab0ca;--accent:#43b5ff}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
header{position:sticky;top:0;z-index:10000;background:rgba(15,25,40,.95);backdrop-filter:blur(6px);border-bottom:1px solid #2a3f5b;padding:10px 12px}
h1{font-size:18px;margin:0}
nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.tab,.btn{position:relative;z-index:10000}
.tab{padding:8px 12px;border:1px solid #2b4a6b;border-radius:10px;background:#142a46;color:#def;cursor:pointer}
.tab.active{background:var(--accent);color:#001428;border-color:#59ccff;font-weight:700}
main{padding:12px}
.panel{display:none;background:var(--panel);border:1px solid #274563;border-radius:12px;padding:12px}
.panel.active{display:block}
.btn,select,.inp{background:#0f2036;border:1px solid #2b4666;color:var(--ink);padding:10px 12px;border-radius:10px}
.btn.primary{background:var(--accent);color:#001428;border-color:#6dd0ff;font-weight:700}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#173256;border:1px solid #2a4a6b;font-size:12px}
.small{font-size:12px;color:var(--mut)}
#stageWrap{position:relative;border:1px solid #294463;border-radius:12px;overflow:hidden;max-width:960px;margin:auto;background:#000}
#photo{display:block;width:100%;height:auto;pointer-events:none}
#videoPreview{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;z-index:5;display:none;background:#000;pointer-events:none}
#liveBadge{position:absolute;left:8px;top:8px;z-index:8;background:#e53;color:#fff;padding:4px 8px;border-radius:8px;font-weight:700;display:none}
#overlay{position:absolute;inset:0;z-index:7;pointer-events:none}
.sprite{position:absolute;left:0;top:0;transform-origin:center center;touch-action:none;user-select:none}
.sprite .hit,.sprite .handle{position:absolute;inset:0;border:2px solid transparent;border-radius:12px;pointer-events:auto}
.sprite .handle{inset:auto;right:-16px;bottom:-16px;width:28px;height:28px;border-radius:50%;background:var(--accent);border:2px solid #062238;display:flex;align-items:center;justify-content:center;color:#062238;font-weight:800}
.sprite.selected .hit{border-color:var(--accent)}
.gallery{display:flex;gap:8px;overflow:auto;padding:8px;background:#0c1c30;border-radius:10px;border:1px solid #263f5f}
.gallery .card{display:flex;align-items:center;gap:8px;background:#11233a;border:1px solid #244363;border-radius:12px;padding:8px 10px;cursor:pointer;white-space:nowrap}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:#102a45;border:1px solid #28476a;border-radius:12px;padding:10px;margin-top:10px}
.range input[type=range]{width:180px}
</style>
</head>
<body>
<header>
  <h1>内見ユーティリティ（v7.4.2）</h1>
  <nav id="tabs"></nav>
</header>

<main>
  <!-- ステージング -->
  <section id="p-stg" class="panel active">
    <div class="row">
      <button class="btn" id="cam">カメラ起動</button>
      <button class="btn" id="shot" disabled>撮影</button>
      <label class="btn"><input id="pick" type="file" accept="image/*" hidden>写真を選ぶ</label>
      <button class="btn" id="auto">家具 自動配置</button>
      <button class="btn" id="clr">家具 クリア</button>
      <span id="scaleBadge" class="badge">スケール未設定</span>
      <button class="btn" id="panic">オーバーレイ強制OFF</button>
    </div>
    <div class="row">
      <label>基準長さ(m) <input id="baseM" class="inp" type="number" step="0.01" value="2.0"></label>
      <button class="btn" id="two">確定（基準2点）</button>
      <div class="controls">
        <div class="range">Yaw <input id="yaw" type="range" min="-180" max="180" value="0"><span id="yvw" class="badge">0°</span></div>
        <div class="range">Pitch <input id="pitch" type="range" min="-80" max="80" value="0"><span id="pvw" class="badge">0°</span></div>
        <div class="range">Roll <input id="roll" type="range" min="-180" max="180" value="0"><span id="rvw" class="badge">0°</span></div>
        <div class="range">スケール <input id="sc" type="range" min="0.2" max="3" step="0.01" value="1"><span id="svw" class="badge">1.00×</span></div>
        <div class="range">ズーム <input id="zoom" type="range" min="0.6" max="2.4" step="0.01" value="1"></div>
      </div>
    </div>

    <div id="stageWrap">
      <span id="liveBadge">LIVE</span>
      <img id="photo" alt="背景">
      <video id="videoPreview" playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>

    <h3 style="margin:14px 0 6px">家具ギャラリー</h3>
    <div class="row">
      <label class="btn"><input id="furnAdd" type="file" accept="image/*" multiple hidden>家具画像を追加</label>
    </div>
    <div id="gal" class="gallery"></div>
  </section>

  <!-- 予備パネル（必要に応じて） -->
  <section id="p-sav" class="panel"><div class="row">
    <button class="btn" id="saveH">この画面をHTML保存</button>
    <a id="dl" class="btn" download="naiken_v742.html" style="display:none">ダウンロード</a>
  </div></section>
</main>

<script>
/* ===== タブ ===== */
const T=[['stg','ステージング'],['sav','保存']];
const tabs=document.getElementById('tabs');
T.forEach((t,i)=>{const b=document.createElement('button'); b.className='tab'+(i?'' :' active'); b.textContent=t[1];
b.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active')); document.getElementById('p-'+t[0]).classList.add('active');};
tabs.appendChild(b);});

/* ===== ステージング ===== */
const stageWrap=document.getElementById('stageWrap'), photo=document.getElementById('photo'), overlay=document.getElementById('overlay');
const video=document.getElementById('videoPreview'), liveBadge=document.getElementById('liveBadge');
let stream=null, ppm=null;

/* クリック貫通 再発防止 */
function overlayOff(){ overlay.style.pointerEvents='none'; }
const overlayGuard={timer:null,on(){ overlay.style.pointerEvents='auto'; clearTimeout(this.timer); this.timer=setTimeout(()=>overlayOff(),2000); }};
document.getElementById('panic').onclick=overlayOff;

// どのクリックでもオーバーレイがONなら即OFF（安全網）
['click','pointerdown','touchstart'].forEach(ev=>{
  document.addEventListener(ev,()=>{ if(overlay.style.pointerEvents==='auto' && !overlay.dataset.pick){ overlayOff(); } },{capture:true,passive:true});
});

function fitTo(img){ const w=Math.min(stageWrap.clientWidth, img.naturalWidth||1280); const r=(img.naturalWidth||1280)/(img.naturalHeight||720); const h=w/r;
  photo.width=w; overlay.width=w; photo.height=h; overlay.height=h; stageWrap.style.height=h+'px'; }

document.getElementById('cam').onclick=async()=>{
  try{
    if(stream) return;
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    video.srcObject=stream; video.style.display='block'; liveBadge.style.display='inline-block'; await video.play();
    // 背景サイズだけ合わせる
    const tmp={naturalWidth: video.videoWidth||1280, naturalHeight: video.videoHeight||720}; fitTo(tmp);
    document.getElementById('shot').disabled=false;
  }catch(e){ alert('カメラ失敗: '+e.message) }
};
function stopCam(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } video.pause(); video.srcObject=null; video.style.display='none'; liveBadge.style.display='none'; document.getElementById('shot').disabled=true; }

document.getElementById('shot').onclick=()=>{ if(!stream) return alert('先にカメラ起動');
  const c=document.createElement('canvas'); const w=video.videoWidth||1280, h=video.videoHeight||720;
  c.width=w; c.height=h; c.getContext('2d').drawImage(video,0,0,w,h); photo.src=c.toDataURL('image/jpeg',0.92); stopCam(); setTimeout(()=>fitTo(photo),0);
};
document.getElementById('pick').onchange=e=>{ const f=e.target.files[0]; if(!f) return; const url=URL.createObjectURL(f); photo.onload=()=>fitTo(photo); photo.src=url; stopCam(); };

/* 基準2点 */
document.getElementById('two').onclick=()=>{ if(!photo.src) return alert('先に画像'); overlayGuard.on(); overlay.getContext('2d').clearRect(0,0,overlay.width,overlay.height); overlay.dataset.pick='1'; document.getElementById('scaleBadge').textContent='基準点を2つクリック'; };
overlay.addEventListener('click',e=>{
  if(overlay.style.pointerEvents!=='auto') return;
  const r=overlay.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top; const cx=overlay.getContext('2d');
  cx.fillStyle='#ffd54a'; cx.beginPath(); cx.arc(x,y,6,0,Math.PI*2); cx.fill();
  if(overlay.dataset.pick==='1'){ overlay.dataset.x1=x; overlay.dataset.y1=y; overlay.dataset.pick='2'; overlayGuard.on(); }
  else { const x1=+overlay.dataset.x1, y1=+overlay.dataset.y1; const d=Math.hypot(x-x1,y-y1); const m=parseFloat(document.getElementById('baseM').value||'1'); ppm=d/m;
    overlayOff(); overlay.removeAttribute('data-pick'); document.getElementById('scaleBadge').textContent='スケール: '+ppm.toFixed(1)+' px/m';
    cx.beginPath(); cx.moveTo(x1,y1); cx.lineTo(x,y); cx.strokeStyle='#ffd54a'; cx.lineWidth=3; cx.stroke(); setTimeout(()=>cx.clearRect(0,0,overlay.width,overlay.height),800);
  }
});

/* 家具 */
const gal=document.getElementById('gal'); let sprites=[], current=null;
document.getElementById('furnAdd').onchange=e=>{
  const fs=[...e.target.files]; if(!fs.length) return;
  const card=document.createElement('div'); card.className='card'; card.textContent='画像×'+fs.length; gal.appendChild(card);
  card.onclick=()=>{ const img=new Image(); img.onload=()=>addSprite(img, stageWrap.clientWidth*0.5, stageWrap.clientHeight*0.75); img.src=URL.createObjectURL(fs[0]); };
};
function addSprite(image,x,y){
  const el=document.createElement('div'); el.className='sprite'; el.style.left=(x||30)+'px'; el.style.top=(y||30)+'px'; el.style.width='200px'; el.style.height='140px';
  el.style.background=`center/contain no-repeat url(${image.src})`; el.innerHTML='<div class="hit"></div><div class="handle">⤮</div>'; stageWrap.appendChild(el);
  const s={el,x:x||30,y:y||30,scale: ppm? (1.8*ppm)/(image.width||200):0.6,roll:0}; sprites.push(s); select(s); apply(s);
  const hit=el.querySelector('.hit'); hit.addEventListener('pointerdown',ev=>{ev.preventDefault(); select(s); const p0=pt(ev), sx=s.x, sy=s.y; const mv=e=>{ const p=pt(e); s.x=sx+(p.x-p0.x); s.y=sy+(p.y-p0.y); apply(s) }; const up=()=>window.removeEventListener('pointermove',mv); window.addEventListener('pointermove',mv); window.addEventListener('pointerup',up,{once:true}); });
  el.querySelector('.handle').addEventListener('pointerdown',ev=>{ev.preventDefault(); const c=ctr(el); const a0=ang(c,pt(ev)), r0=s.roll; const mv=e=>{ s.roll=r0+(ang(c,pt(e))-a0); apply(s) }; const up=()=>window.removeEventListener('pointermove',mv); window.addEventListener('pointermove',mv); window.addEventListener('pointerup',up,{once:true}); });
  let last=0; hit.addEventListener('click',e=>{ const t=Date.now(); if(t-last<300){ removeSprite(s) } last=t });
}
function removeSprite(s){ s.el.remove(); const i=sprites.indexOf(s); if(i>=0) sprites.splice(i,1); if(current===s) select(null); }
function select(s){ sprites.forEach(x=>x.el.classList.remove('selected')); current=s; if(s) s.el.classList.add('selected'); }
function apply(s){ s.el.style.left=s.x+'px'; s.el.style.top=s.y+'px'; s.el.style.transform=`translate(-50%,-50%) rotate(${s.roll}deg) scale(${s.scale})`; }
function pt(e){ const r=stageWrap.getBoundingClientRect(); return {x:e.clientX-r.left,y:e.clientY-r.top}; }
function ctr(el){ const r=el.getBoundingClientRect(), p=stageWrap.getBoundingClientRect(); return {x:(r.left+r.right)/2-p.left, y:(r.top+r.bottom)/2-p.top}; }
function ang(a,b){ return Math.atan2(b.y-a.y,b.x-a.x)*180/Math.PI }

/* 保存 */
document.getElementById('saveH').onclick=()=>{ const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'}); const url=URL.createObjectURL(blob); const a=document.getElementById('dl'); a.href=url; a.style.display='inline-block'; };

/* タブ初期化 */
document.querySelector('.tab').click();
</script>
</body></html>