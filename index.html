<!DOCTYPE html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>内見ステージング（クリック再発防止・3D回転・基準2点）</title>
<style>
:root{--bg:#0e1a2a;--panel:#132338;--btn:#1f3b5b;--text:#eaf3ff;--accent:#31c3ff}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
.toolbar{position:sticky;top:0;z-index:50;display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:linear-gradient(180deg,rgba(14,26,42,.95),rgba(14,26,42,.75));backdrop-filter:blur(6px)}
.btn{background:var(--btn);border:none;border-radius:10px;color:var(--text);padding:10px 14px;font-weight:600;cursor:pointer}
.btn.primary{background:#0ea5e9}
.small{font-size:12px;padding:6px 8px}
.panel{background:var(--panel);margin:10px;border-radius:14px;padding:10px}
.hint{opacity:.85;font-size:12px}
#wrap{position:relative;margin:10px;border-radius:14px;background:#000;overflow:hidden;
  perspective: 1200px; transform-style:preserve-3d}
#stage,#ov{display:block;width:100%;height:auto}
#ov{position:absolute;left:0;top:0;pointer-events:none}
.gallery{display:flex;gap:8px;overflow:auto;padding:8px}
.gallery img{height:64px;border-radius:10px;cursor:pointer}
.sprite{position:absolute;left:0;top:0;touch-action:none;user-select:none;transform-origin:center center}
.sprite .hit{position:absolute;inset:0;border:2px solid transparent;border-radius:12px}
.sprite.selected .hit{border-color:var(--accent)}
.handle{position:absolute;right:-16px;bottom:-16px;width:28px;height:28px;border-radius:50%;background:var(--accent);border:2px solid #062238;display:flex;align-items:center;justify-content:center;color:#062238;font-weight:800}
.controls{position:sticky;bottom:0;z-index:45;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;padding:10px;background:linear-gradient(0deg,rgba(14,26,42,.85),transparent)}
.range{display:flex;align-items:center;gap:6px}
.range input[type=range]{width:180px}
.badge{padding:4px 8px;border-radius:8px;background:#0b2d4d}
</style></head>
<body>
<div class="toolbar">
  <button id="cam" class="btn">カメラ起動</button>
  <button id="shot" class="btn">撮影</button>
  <label class="btn" for="file">写真を選ぶ</label>
  <input id="file" type="file" accept="image/*" capture="environment" style="display:none">
  <label class="btn" for="furn">家具画像を追加</label>
  <input id="furn" type="file" accept="image/*" multiple style="display:none">
  <button id="auto" class="btn primary">家具 自動配置</button>
  <button id="clear" class="btn">家具 クリア</button>
  <button id="panic" class="btn small">オーバーレイ強制OFF</button>
  <span id="msg" class="hint"></span>
</div>

<div id="wrap">
  <canvas id="stage" width="1280" height="720"></canvas>
  <canvas id="ov" width="1280" height="720"></canvas>
</div>

<div class="panel">
  <div class="hint">手順: ①「カメラ起動→撮影」または「写真を選ぶ」。② <button id="pick" class="btn small">確定（基準2点）</button> を押し、画像上で2点クリック → 実寸入力：
    <input id="len" type="number" step="0.01" value="2.0" style="width:80px"> m。③ 家具はギャラリーから配置（タップ）。</div>
</div>

<div class="panel">
  <div class="badge">家具ギャラリー</div>
  <div id="gal" class="gallery"></div>
</div>

<div class="controls">
  <div class="range">Yaw(水平) <input id="yaw" type="range" min="-180" max="180" value="0"><span id="yvw">0°</span></div>
  <div class="range">Pitch(前後) <input id="pitch" type="range" min="-80" max="80" value="0"><span id="pvw">0°</span></div>
  <div class="range">Roll(回転) <input id="roll" type="range" min="-180" max="180" value="0"><span id="rvw">0°</span></div>
  <div class="range">スケール <input id="sc" type="range" min="0.2" max="3" step="0.01" value="1"><span id="svw">1.00×</span></div>
  <div class="range">ズーム <input id="zoom" type="range" min="0.6" max="2.4" step="0.01" value="1"></div>
</div>

<script>
const wrap=document.getElementById('wrap');
const stage=document.getElementById('stage'), ctx=stage.getContext('2d',{willReadFrequently:true});
const ov=document.getElementById('ov'), octx=ov.getContext('2d');
const gal=document.getElementById('gal'); const msg=(t)=>document.getElementById('msg').textContent=t;

let base=null, ppm=null, picking=false, pts=[];

/* ---------- 画像読み込み / 描画 ---------- */
function fit(img){
  const maxW=Math.min(window.innerWidth-20,1400), r=img.width/img.height, w=Math.min(maxW,img.width), h=w/r;
  stage.width=w; stage.height=h; ov.width=w; ov.height=h; wrap.style.height=h+'px';
  draw();
}
function draw(){ if(!base) return; ctx.clearRect(0,0,stage.width,stage.height); ctx.drawImage(base,0,0,stage.width,stage.height); }
document.getElementById('file').onchange=e=>{
  const f=e.target.files[0]; if(!f) return; const u=URL.createObjectURL(f); const img=new Image();
  img.onload=()=>{ base=img; fit(img); URL.revokeObjectURL(u) }; img.src=u;
};
document.getElementById('cam').onclick=async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    const v=document.createElement('video'); v.srcObject=stream; v.playsInline=true; await v.play();
    const cx=document.createElement('canvas'); cx.width=v.videoWidth; cx.height=v.videoHeight;
    cx.getContext('2d').drawImage(v,0,0); stream.getTracks().forEach(t=>t.stop());
    const img=new Image(); img.onload=()=>{ base=img; fit(img) }; img.src=cx.toDataURL('image/jpeg',0.92);
  }catch(e){ alert('カメラ失敗: '+e.message) }
};
document.getElementById('shot').onclick=draw;

/* ---------- 基準2点（スケール確定）＋オーバーレイ再発防止 ---------- */
const overlayGuard={ timer:null, on(){
  ov.style.pointerEvents='auto';
  clearTimeout(this.timer); this.timer=setTimeout(()=>this.off(),2000); // 2秒で自動OFF
}, off(){ ov.style.pointerEvents='none'; msg('') } };
document.getElementById('panic').onclick=()=>overlayGuard.off();

document.getElementById('pick').onclick=()=>{
  if(!base){ alert('先に画像を読み込んでください'); return; }
  picking=true; pts=[]; octx.clearRect(0,0,ov.width,ov.height); msg('基準2点をクリック…'); overlayGuard.on();
};
ov.addEventListener('click',e=>{
  if(!picking) return;
  const r=ov.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top; pts.push({x,y});
  octx.fillStyle='#ffd54a'; octx.strokeStyle='#ffd54a'; octx.lineWidth=3;
  octx.beginPath(); octx.arc(x,y,6,0,Math.PI*2); octx.fill();
  if(pts.length===2){
    octx.beginPath(); octx.moveTo(pts[0].x,pts[0].y); octx.lineTo(pts[1].x,pts[1].y); octx.stroke();
    const d=Math.hypot(pts[0].x-pts[1].x,pts[0].y-pts[1].y), m=parseFloat(document.getElementById('len').value)||1;
    ppm=d/m; picking=false; overlayGuard.off(); msg('スケール:'+ppm.toFixed(1)+' px/m');
  }else{ overlayGuard.on(); }
});

/* ---------- 家具ギャラリー（端末から追加） ---------- */
function addToGallery(file){
  const url=URL.createObjectURL(file), img=new Image();
  img.onload=()=>{ const t=new Image(); t.src=url; t.alt=file.name;
    t.onclick=()=>addSprite(img,1.8, stage.width*0.5, stage.height*0.75); gal.appendChild(t);
  };
  img.src=url;
}
document.getElementById('furn').onchange=e=>{ [...e.target.files].forEach(addToGallery); };

/* ---------- 3Dスプライト：Yaw/Pitch/Roll & ジェスチャ ---------- */
const sprites=[]; let current=null;
function addSprite(image, realWm, x,y){
  const el=document.createElement('div'); el.className='sprite';
  const scale= ppm ? (realWm*ppm)/image.width : 0.5;
  el.style.left=(x||30)+'px'; el.style.top=(y||30)+'px';
  el.style.width=image.width+'px'; el.style.height=image.height+'px';
  el.style.background=`center/contain no-repeat url(${image.src})`;
  el.innerHTML='<div class="hit"></div><div class="handle">⤮</div>';
  wrap.appendChild(el);

  const s={el,x:x||30,y:y||30,scale:scale,yaw:0,pitch:0,roll:0};
  sprites.push(s); select(s); apply(s);

  // ドラッグ移動
  let dragging=false, p0=null, start=null;
  el.querySelector('.hit').addEventListener('pointerdown',ev=>{
    ev.preventDefault(); dragging=true; p0=pt(ev); start={x:s.x,y:s.y}; select(s);
    window.addEventListener('pointermove',move); window.addEventListener('pointerup',up,{once:true});
  });
  function move(e){ if(!dragging) return; const p=pt(e); s.x=start.x+(p.x-p0.x); s.y=start.y+(p.y-p0.y); apply(s) }
  function up(){ dragging=false; window.removeEventListener('pointermove',move) }

  // ロール回転ハンドル
  el.querySelector('.handle').addEventListener('pointerdown',ev=>{
    ev.preventDefault(); const center=ctr(el); const base=angle(center,pt(ev)); const r0=s.roll;
    const mv=e=>{ s.roll=r0+(angle(center,pt(e))-base); apply(s); updateUI() };
    const up=()=>window.removeEventListener('pointermove',mv);
    window.addEventListener('pointermove',mv); window.addEventListener('pointerup',up,{once:true});
  });

  // 2本指ジェスチャ：ピンチ＝スケール、ねじり＝ロール、平均水平移動=Yaw、平均垂直移動=Pitch
  let touches=new Map(), g0=null;
  el.addEventListener('touchstart',e=>{ if(e.touches.length>1) e.preventDefault() },{passive:false});
  el.addEventListener('pointerdown',e=>{ touches.set(e.pointerId,pt(e)) });
  el.addEventListener('pointermove',e=>{
    if(!touches.has(e.pointerId)) return; touches.set(e.pointerId,pt(e));
    if(touches.size===2){
      const [a,b]=[...touches.values()], cx=(a.x+b.x)/2, cy=(a.y+b.y)/2;
      const d=Math.hypot(a.x-b.x,a.y-b.y), ang=Math.atan2(b.y-a.y,b.x-a.x);
      if(!g0){ g0={d,ang,cx,cy,scale:s.scale,yaw:s.yaw,pitch:s.pitch,roll:s.roll}; }
      // ピンチ
      s.scale=Math.max(.2,Math.min(3,g0.scale*(d/g0.d)));
      // ねじり→Roll
      s.roll=(g0.roll + (ang-g0.ang)*180/Math.PI);
      // 平均移動→Yaw/Pitch
      s.yaw=g0.yaw + (cx-g0.cx)*0.2;
      s.pitch=g0.pitch - (cy-g0.cy)*0.2;
      apply(s); updateUI();
    }
  });
  window.addEventListener('pointerup',e=>{ touches.delete(e.pointerId); if(touches.size<2) g0=null });

  // ダブルタップ削除
  let last=0; el.querySelector('.hit').addEventListener('click',e=>{ const t=Date.now(); if(t-last<300){ removeSprite(s) } last=t });

  return s;
}
function removeSprite(s){ s.el.remove(); const i=sprites.indexOf(s); if(i>=0) sprites.splice(i,1); if(current===s) select(null) }
function select(s){ sprites.forEach(x=>x.el.classList.remove('selected')); current=s; if(s){ s.el.classList.add('selected'); syncUI(s) } }
function apply(s){
  s.el.style.left=s.x+'px'; s.el.style.top=s.y+'px';
  s.el.style.transform=`translate(-50%,-50%) rotateZ(${s.roll}deg) rotateX(${s.pitch}deg) rotateY(${s.yaw}deg) scale(${s.scale})`;
}
function syncUI(s){
  document.getElementById('yaw').value=s.yaw; document.getElementById('pitch').value=s.pitch; document.getElementById('roll').value=s.roll; document.getElementById('sc').value=s.scale;
  updateUI();
}
function updateUI(){
  if(!current) return;
  document.getElementById('yvw').textContent=(+document.getElementById('yaw').value).toFixed(0)+'°';
  document.getElementById('pvw').textContent=(+document.getElementById('pitch').value).toFixed(0)+'°';
  document.getElementById('rvw').textContent=(+document.getElementById('roll').value).toFixed(0)+'°';
  document.getElementById('svw').textContent=(+document.getElementById('sc').value).toFixed(2)+'×';
}
['yaw','pitch','roll','sc'].forEach(id=>{
  document.getElementById(id).oninput=e=>{
    if(!current) return; current[id==='sc'?'scale':id]=parseFloat(e.target.value)||0; apply(current); updateUI();
  }
});

// 便利：背景ズーム
document.getElementById('zoom').oninput=e=>{
  const z=parseFloat(e.target.value); stage.style.transform=`scale(${z})`; ov.style.transform=`scale(${z})`; wrap.style.height=(ov.height*z)+'px';
};

// 自動配置（初期角度提案：床スナップ＆微ピッチ）
document.getElementById('auto').onclick=()=>{
  if(gal.children.length===0) return alert('家具画像を追加してください');
  const W=ov.width, H=ov.height, y=H*0.74; const imgs=[...gal.children];
  const picks=[imgs[0]||imgs.at(-1), imgs[1]||imgs.at(-1), imgs[2]||imgs.at(-1)];
  const pos=[0.28,0.52,0.75];
  picks.forEach((t,i)=>{
    const im=new Image(); im.src=t.src; im.onload=()=>{ const s=addSprite(im,[1.8,1.2,0.6][i], W*pos[i], y);
      s.yaw= snapYaw(s.yaw); s.pitch=-5; s.roll=0; apply(s); syncUI(s);
    }
  });
};
function snapYaw(y){ // 0/90/180/270に吸着
  const a=((y%360)+360)%360; const snaps=[0,90,180,270]; let best=0,err=999;
  snaps.forEach(n=>{const d=Math.abs(a-n); if(d<err){err=d;best=n}})
  return (a<best?y-(a-best):y+(best-a));
}
document.getElementById('clear').onclick=()=>{ sprites.forEach(removeSprite); };

/* ---------- 共通ユーティリティ ---------- */
function pt(e){ const r=wrap.getBoundingClientRect(); return {x:e.clientX-r.left,y:e.clientY-r.top} }
function ctr(el){ const r=el.getBoundingClientRect(), p=wrap.getBoundingClientRect(); return {x:(r.left+r.right)/2-p.left, y:(r.top+r.bottom)/2-p.top} }
function angle(a,b){ return Math.atan2(b.y-a.y,b.x-a.x)*180/Math.PI }

/* ---------- 初期状態：オーバーレイは常に無効／監視 ---------- */
overlayGuard.off();
setInterval(()=>{ // 監視：もし有効のままなら自動無効化
  if(ov.style.pointerEvents!=='none' && !picking) overlayGuard.off();
}, 1200);
</script>
</body></html>