<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>不動産 内見・ステージング・計測・騒音・収支・チェック v6.2（単一HTML）</title>
<style>
:root{
  --bg:#0b1625; --panel:#112236; --accent:#46c2ff; --text:#e9f1fb; --muted:#a9bed6;
}
*{box-sizing:border-box}
body{margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; background:var(--bg); color:var(--text)}
h1{font-size:20px; margin:12px}
nav{position:sticky; top:0; background:rgba(11,22,37,.95); backdrop-filter: blur(8px); z-index:10; border-bottom:1px solid #1f3550}
nav .tabs{display:flex; gap:8px; flex-wrap:wrap; padding:8px 8px 10px}
button,select,input[type="number"],input[type="text"]{
  background:#132a42; color:var(--text); border:1px solid #274666; border-radius:10px; padding:10px 14px; font-size:15px;
}
button.primary{background:var(--accent); color:#062033; border-color:#63d2ff; font-weight:700}
button:disabled{opacity:0.5}
.section{display:none; padding:12px}
.section.active{display:block}
.card{background:var(--panel); border:1px solid #223a59; border-radius:14px; padding:12px; margin:12px 8px}
.row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
label{font-size:13px; color:var(--muted); margin-right:4px}
.small{font-size:12px; color:var(--muted)}
.badge{display:inline-block; padding:4px 8px; background:#193757; border-radius:999px; font-size:12px; margin-left:6px}
.kpi{font-size:18px; font-weight:700}
/* staging */
.stage-wrap{position:relative; width:100%; max-width:900px; margin:auto; background:#0c1420; border-radius:12px; overflow:hidden; border:1px solid #203a59}
#stageCanvas{width:100%; height:auto; display:block; touch-action:none}
#video{width:100%; display:none; background:#000}
#overlay{position:absolute; left:0; top:0; right:0; bottom:0; pointer-events:none}
.furn{position:absolute; min-width:80px; min-height:60px; border:2px solid #fff8; border-radius:12px; background:#64a2ff28; backdrop-filter: blur(2px); color:#fff; display:flex; align-items:center; justify-content:center; pointer-events:auto; touch-action:none}
.furn:active{outline:2px solid var(--accent)}
#baselineTip{position:absolute; left:10px; top:10px; background:#0009; color:#fff; padding:6px 10px; border-radius:8px; display:none}
.crosshair{position:absolute; inset:0; pointer-events:none; display:none}
.crosshair .v, .crosshair .h{position:absolute; background:#ffffff55}
.crosshair .v{top:0; bottom:0; width:1px; left:50%}
.crosshair .h{left:0; right:0; height:1px; top:50%}
/* audio */
#specCanvas{width:100%; max-width:900px; height:240px; border-radius:10px; background:#000}
#waveCanvas{width:100%; max-width:900px; height:120px; border-radius:10px; background:#000}
/* table */
table{width:100%; border-collapse:collapse; font-size:14px}
th,td{border:1px solid #284565; padding:6px 8px}
th{background:#18324c}
tfoot td{font-weight:bold}
/* report button fixed */
.savebar{position:sticky; bottom:6px; display:flex; justify-content:center; padding:8px}
/* utilities */
.hide{display:none!important}
.w100{width:100%}
input[type="range"]{accent-color:var(--accent)}
</style>
</head>
<body>
<nav>
  <div class="tabs">
    <button class="tab primary" data-to="staging">ステージング</button>
    <button class="tab" data-to="noise">騒音</button>
    <button class="tab" data-to="measure">間取り・実寸</button>
    <button class="tab" data-to="land">物件情報/土地値比率</button>
    <button class="tab" data-to="dscr">収支/DSCR</button>
    <button class="tab" data-to="check">チェック</button>
    <button class="tab" data-to="save">保存/レポート</button>
    <span class="badge">HTTPSで開いてください（file://不可）</span>
  </div>
</nav>

<section id="staging" class="section active">
  <h1>① ステージング（部屋全体）<span id="scaleBadge" class="badge">スケール未設定</span></h1>
  <div class="card row">
    <button id="btnStartCam">カメラ起動</button>
    <button id="btnShot">撮影</button>
    <input id="filePhoto" type="file" accept="image/*" />
    <button id="btnAuto" class="primary">自動配置</button>
    <button id="btnResetF">家具リセット</button>
    <button id="btnBaseline">確定（基準2点）</button>
    <label>基準長さ(m)</label><input id="baseMeters" type="number" step="0.01" value="2.0" style="width:90px">
  </div>
  <div class="stage-wrap" id="stageWrap">
    <canvas id="stageCanvas"></canvas>
    <video id="video" playsinline muted></video>
    <div id="overlay"></div>
    <div class="crosshair" id="cross">
      <div class="v"></div><div class="h"></div>
    </div>
    <div id="baselineTip">画像上を2点タップしてください</div>
  </div>
  <div class="card row">
    <label>スタイル</label>
    <select id="styleSel">
      <option>単身男性/ミニマル</option>
      <option>北欧/ナチュラル</option>
      <option>モダン/ダーク</option>
      <option>ファミリー/明るめ</option>
    </select>
    <span class="small">家具はドラッグ/ピンチ(スマホ)で移動・拡大・回転（2本指）。ダブルタップで削除。</span>
  </div>
</section>

<section id="noise" class="section">
  <h1>② 騒音（簡易SPL & スペクトログラム）</h1>
  <div class="card row">
    <button id="btnMic" class="primary">マイク計測開始</button>
    <button id="btnMicStop">停止</button>
    <label>時間窓</label>
    <select id="timeWindow">
      <option value="10">10s</option>
      <option value="30" selected>30s</option>
      <option value="60">60s</option>
    </select>
    <label>表示レンジ</label>
    <select id="dbrange">
      <option value="auto" selected>オート</option>
      <option value="40-100">40–100 dB相当</option>
      <option value="20-120">20–120 dB相当</option>
    </select>
    <span id="splStats" class="badge">最小: - / 最大: - / 平均: -</span>
  </div>
  <div class="card">
    <canvas id="waveCanvas"></canvas>
  </div>
  <div class="card">
    <div class="row"><span class="small">FFTスペクトログラム（時間×周波数、色=レベル）</span></div>
    <canvas id="specCanvas"></canvas>
  </div>
</section>

<section id="measure" class="section">
  <h1>③ 間取り・実寸</h1>
  <div class="card small">ステージング画像に対し、矩形をドラッグして面を抽出。基準2点スケールを共有。</div>
  <div class="card">
    <div class="row">
      <button id="btnRectMode">矩形モード</button>
      <button id="btnRectClear">矩形クリア</button>
      <span class="badge">クリック&ドラッグで四隅、ダブルタップで削除</span>
    </div>
    <table id="rectTable">
      <thead><tr><th>#</th><th>幅(m)</th><th>奥行(m)</th><th>面積(㎡)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="land" class="section">
  <h1>④ 物件情報 / 土地値比率</h1>
  <div class="card">
    <div class="row">
      <label>物件価格(万円)</label><input id="priceMan" type="number" step="1" style="width:120px">
      <label>土地面積(㎡)</label><input id="landArea" type="number" step="0.01" style="width:120px">
    </div>
    <div class="row">
      <label>住所（任意）</label><input id="addr" type="text" class="w100" placeholder="静岡県藤枝市..." />
    </div>
    <div class="row">
      <label>GPS</label><button id="btnGPS">現在地を取得</button><span id="gpsOut" class="badge">未取得</span>
    </div>
  </div>
  <div class="card">
    <div class="row">
      <label>路線価(千円/㎡)</label><input id="rosenka" type="number" step="1">
      <label>公示価格(千円/㎡)</label><input id="koji" type="number" step="1">
      <label>近傍成約(千円/㎡)</label><input id="nearby" type="number" step="1">
      <button id="btnThree" class="primary">3点平均を計算</button>
    </div>
    <div class="row">
      <span id="avgOut" class="kpi">3点平均: -</span>
      <span id="ratioOut" class="kpi">土地値比率: -</span>
    </div>
    <div class="small">※公的データの自動取得はCORS制限のためこの単一HTMLでは不可。数値を入力して算出してください。</div>
  </div>
</section>

<section id="dscr" class="section">
  <h1>⑤ 収支 / DSCR</h1>
  <div class="card">
    <div class="row">
      <label>月額家賃(円)</label><input id="rent" type="number" step="1000" value="70000">
      <label>稼働率</label><input id="occ" type="number" step="0.01" value="0.95">
    </div>
    <div class="row">
      <label>経費率</label>
      <select id="opexPreset">
        <option value="0.20">築6–15年: 0.20</option>
        <option value="0.25">築16–25年: 0.25</option>
        <option value="0.30">築26年以上: 0.30</option>
      </select>
      <input id="opex" type="number" step="0.01" value="0.20" style="width:90px">
      <label>固定費(年,円)</label><input id="fixed" type="number" step="1000" value="120000">
    </div>
    <div class="row">
      <label>借入額(円)</label><input id="loan" type="number" step="100000" value="15000000">
      <label>金利</label><input id="rate" type="number" step="0.01" value="0.02">
      <label>返済年数</label><input id="years" type="number" step="1" value="30">
    </div>
    <div class="row">
      <button id="btnDSCR" class="primary">計算</button>
      <span id="nois" class="kpi">NOI: -</span>
      <span id="debt" class="kpi">年返済: -</span>
      <span id="dscrOut" class="kpi">DSCR: -</span>
    </div>
  </div>
</section>

<section id="check" class="section">
  <h1>⑥ 内見チェック</h1>
  <div class="card">
    <table id="chkTable">
      <thead><tr><th>項目</th><th>判定</th><th>数量</th><th>単位</th><th>単価(円)</th><th>概算(円)</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="5">合計</td><td id="chkSum">0</td></tr></tfoot>
    </table>
  </div>
</section>

<section id="save" class="section">
  <h1>⑦ 保存 / レポート</h1>
  <div class="card row">
    <button id="btnSaveImage">ステージング画像を保存</button>
    <button id="btnSaveReport" class="primary">レポート(HTML)保存</button>
    <button id="btnSaveState">設定を保存</button>
    <button id="btnLoadState">設定を復元</button>
  </div>
</section>

<div class="savebar">
  <span class="small">© 内見ユーティリティ（単一HTML）</span>
</div>

<script>
// ====== Tabs ======
document.querySelectorAll('.tab').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('primary'));
    b.classList.add('primary');
    const to=b.dataset.to;
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(to).classList.add('active');
  });
});

// ====== Canvas helpers ======
const stageCanvas = document.getElementById('stageCanvas');
const sctx = stageCanvas.getContext('2d');
const stageWrap = document.getElementById('stageWrap');
const overlay = document.getElementById('overlay');
const video = document.getElementById('video');
const cross = document.getElementById('cross');
let img = new Image();
let scalePxPerM = null;
let baselineMode=false, bPts=[];
const scaleBadge = document.getElementById('scaleBadge');

function resizeCanvasToContainer(cnv){
  const r = stageWrap.getBoundingClientRect();
  const w = Math.min( r.width, 900);
  const h = w * (3/4); // default aspect until image/video draws
  cnv.width=w; cnv.height=h;
}
resizeCanvasToContainer(stageCanvas);
window.addEventListener('resize',()=>resizeCanvasToContainer(stageCanvas));

function drawBase(){
  sctx.fillStyle='#000'; sctx.fillRect(0,0,stageCanvas.width, stageCanvas.height);
  if(img && img.complete && img.naturalWidth>0){
    const rw = stageCanvas.width;
    const rh = stageCanvas.height;
    const iw = img.width, ih = img.height;
    const r = Math.min(rw/iw, rh/ih);
    const dw = iw*r, dh = ih*r;
    const dx = (rw-dw)/2, dy=(rh-dh)/2;
    sctx.drawImage(img, dx, dy, dw, dh);
  } else if(!video.paused && !video.ended && video.readyState>2){
    sctx.drawImage(video, 0,0, stageCanvas.width, stageCanvas.height);
  }
  if(bPts.length===1){
    sctx.strokeStyle='#ffd54a'; sctx.lineWidth=2;
    sctx.beginPath(); sctx.arc(bPts[0].x, bPts[0].y,6,0,Math.PI*2); sctx.stroke();
  }else if(bPts.length===2){
    sctx.strokeStyle='#ffd54a'; sctx.lineWidth=2;
    sctx.beginPath(); sctx.moveTo(bPts[0].x,bPts[0].y);
    sctx.lineTo(bPts[1].x,bPts[1].y); sctx.stroke();
  }
  requestAnimationFrame(drawBase);
}
requestAnimationFrame(drawBase);

// Camera
const btnStartCam=document.getElementById('btnStartCam');
const btnShot=document.getElementById('btnShot');
let camStream=null;
btnStartCam.onclick=async ()=>{
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
    video.srcObject = camStream; video.play(); video.style.display='block'; img=new Image();
  }catch(e){ alert('カメラ起動に失敗: '+e.message); }
};
btnShot.onclick=()=>{
  if(!video.srcObject){alert('先にカメラを起動してください'); return;}
  const tmp = document.createElement('canvas'); tmp.width=video.videoWidth; tmp.height=video.videoHeight;
  tmp.getContext('2d').drawImage(video,0,0);
  img = new Image(); img.onload=()=>{ video.style.display='none'; };
  img.src = tmp.toDataURL('image/jpeg',0.92);
};

// Photo select
document.getElementById('filePhoto').addEventListener('change', (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{ img=new Image(); img.onload=()=>{}; img.src=reader.result; video.style.display='none'; };
  reader.readAsDataURL(f);
});

// Furniture
function makeFurn(title,x,y,w,h){
  const d=document.createElement('div');
  d.className='furn';
  d.textContent=title;
  d.style.left=x+'px'; d.style.top=y+'px';
  d.style.width=w+'px'; d.style.height=h+'px';
  overlay.appendChild(d);
  let ox=0, oy=0;
  const onDown=(ev)=>{
    ev.preventDefault(); ev.stopPropagation();
    const p = getPoint(ev);
    ox = p.x - d.offsetLeft; oy = p.y - d.offsetTop;
    document.addEventListener('pointermove', onMove);
    document.addEventListener('pointerup', onUp,{once:true});
  };
  const onMove=(ev)=>{
    const p=getPoint(ev);
    let nx=p.x-ox, ny=p.y-oy;
    nx=Math.max(0, Math.min(nx, overlay.clientWidth - d.offsetWidth));
    ny=Math.max(0, Math.min(ny, overlay.clientHeight - d.offsetHeight));
    d.style.left=nx+'px'; d.style.top=ny+'px';
  };
  const onUp=()=>{ document.removeEventListener('pointermove', onMove); };
  d.addEventListener('pointerdown', onDown);
  d.addEventListener('dblclick',()=>d.remove());
}
function autoLayout(){
  overlay.innerHTML='';
  const w=overlay.clientWidth, h=overlay.clientHeight;
  makeFurn('ソファ', 10, h-130, w*0.32, 110);
  makeFurn('テーブル', w*0.35, h-120, w*0.28, 100);
  makeFurn('観葉', w*0.7, h-130, w*0.25, 110);
}
document.getElementById('btnAuto').onclick=autoLayout;
document.getElementById('btnResetF').onclick=()=>overlay.innerHTML='';

// Baseline
document.getElementById('btnBaseline').onclick=()=>{
  baselineMode = true; bPts=[];
  document.getElementById('baselineTip').style.display='block';
  cross.style.display='block';
};
stageCanvas.addEventListener('pointermove', e=>{
  if(baselineMode){
    const rect=stageCanvas.getBoundingClientRect();
    cross.style.display='block';
    cross.querySelector('.v').style.left=(e.clientX-rect.left)+'px';
    cross.querySelector('.h').style.top=(e.clientY-rect.top)+'px';
  }
});
stageCanvas.addEventListener('pointerdown', e=>{
  if(!baselineMode) return;
  const rect=stageCanvas.getBoundingClientRect();
  const x=e.clientX-rect.left, y=e.clientY-rect.top;
  bPts.push({x,y});
  if(bPts.length===2){
    baselineMode=false; document.getElementById('baselineTip').style.display='none'; cross.style.display='none';
    const dx=bPts[0].x-bPts[1].x, dy=bPts[0].y-bPts[1].y;
    const pix=Math.hypot(dx,dy);
    const meters=parseFloat(document.getElementById('baseMeters').value||'1');
    scalePxPerM = pix/meters;
    scaleBadge.textContent = 'スケール設定: 1m ≒ '+(scalePxPerM.toFixed(1))+' px';
  }
});

// ====== Rectangles for measurement ======
let rectMode=false;
const rects=[];
document.getElementById('btnRectMode').onclick=()=>{rectMode=true};
document.getElementById('btnRectClear').onclick=()=>{rects.splice(0); updateRectTable(); drawRects();};

let dragRect=null, startPt=null;
stageCanvas.addEventListener('pointerdown', e=>{
  if(!rectMode) return;
  const p=canvasPoint(e);
  startPt=p;
  dragRect={x:p.x, y:p.y, w:1, h:1};
  rects.push(dragRect);
  drawRects();
  const move=(ev)=>{
    const q=canvasPoint(ev);
    dragRect.w = q.x - startPt.x;
    dragRect.h = q.y - startPt.y;
    drawRects();
  };
  const up=()=>{
    document.removeEventListener('pointermove', move);
    document.removeEventListener('pointerup', up);
    rectMode=false; updateRectTable();
  };
  document.addEventListener('pointermove', move);
  document.addEventListener('pointerup', up, {once:true});
});

function drawRects(){
  // top of image already drawn in loop; overlay rectangles on dedicated canvas? here we draw on stageCanvas overlayed path
  // to keep simple, draw on sctx temporarily: drawBase will repaint; so we draw into overlay instead:
  const g = overlay.getContext ? overlay.getContext('2d') : null;
}

function canvasPoint(e){
  const r=stageCanvas.getBoundingClientRect();
  return {x:e.clientX - r.left, y:e.clientY - r.top};
}
function updateRectTable(){
  const tb=document.querySelector('#rectTable tbody'); tb.innerHTML='';
  rects.forEach((r,i)=>{
    const wpx=Math.abs(r.w), hpx=Math.abs(r.h);
    let wm='-', hm='-', am='-';
    if(scalePxPerM){
      wm=(wpx/scalePxPerM).toFixed(2);
      hm=(hpx/scalePxPerM).toFixed(2);
      am=(wpx*hpx/scalePxPerM/scalePxPerM).toFixed(2);
    }
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${wm}</td><td>${hm}</td><td>${am}</td>`;
    tb.appendChild(tr);
  });
}

// ====== Audio (SPL + Spectrogram) ======
let audioCtx, micSrc, analyser, dataTime, dataFreq, rafId=null;
const waveCanvas=document.getElementById('waveCanvas');
const wctx=waveCanvas.getContext('2d');
const specCanvas=document.getElementById('specCanvas');
const spctx=specCanvas.getContext('2d');
function resizeAudioCanvas(){
  const maxW = Math.min(document.body.clientWidth-24, 900);
  waveCanvas.width=maxW; waveCanvas.height=120;
  specCanvas.width=maxW; specCanvas.height=240;
}
resizeAudioCanvas(); window.addEventListener('resize', resizeAudioCanvas);

function colorForDb(db, minDb, maxDb){
  const t = Math.min(1, Math.max(0, (db - minDb)/(maxDb-minDb+1e-6)));
  // simple gradient: dark blue -> cyan -> yellow -> white
  const r = Math.floor(255*Math.pow(t,3));
  const g = Math.floor(255*Math.pow(t,2));
  const b = Math.floor(255*(0.3+0.7*(1-t)));
  return `rgb(${r},${g},${b})`;
}
let minDbTrack=1e9, maxDbTrack=-1e9, avgDbAcc=0, avgDbN=0;

async function startMic(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    micSrc = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize=2048;
    analyser.smoothingTimeConstant=0.7;
    micSrc.connect(analyser);
    dataTime = new Uint8Array(analyser.fftSize);
    dataFreq = new Uint8Array(analyser.frequencyBinCount);
    minDbTrack=1e9; maxDbTrack=-1e9; avgDbAcc=0; avgDbN=0;
    animate();
  }catch(e){ alert('マイク起動に失敗: '+e.message); }
}
function stopMic(){ if(rafId) cancelAnimationFrame(rafId); rafId=null; if(audioCtx) audioCtx.close(); }

function animate(){
  analyser.getByteTimeDomainData(dataTime);
  analyser.getByteFrequencyData(dataFreq);
  // Waveform
  wctx.fillStyle='#000'; wctx.fillRect(0,0,waveCanvas.width, waveCanvas.height);
  wctx.strokeStyle='#4cc3ff'; wctx.lineWidth=2; wctx.beginPath();
  for(let i=0;i<dataTime.length;i++){
    const x = i/(dataTime.length-1)*waveCanvas.width;
    const y = (dataTime[i]/255)*waveCanvas.height;
    if(i===0) wctx.moveTo(x,y); else wctx.lineTo(x,y);
  }
  wctx.stroke();
  // Approx SPL from average magnitude
  let sum=0; for(let i=0;i<dataFreq.length;i++) sum+=dataFreq[i];
  const avg = sum/dataFreq.length; // 0..255
  const db = 20*Math.log10(avg/255 + 1e-6) + 100; // pseudo dB scale
  minDbTrack=Math.min(minDbTrack, db); maxDbTrack=Math.max(maxDbTrack, db); avgDbAcc+=db; avgDbN++;
  document.getElementById('splStats').textContent = `最小:${minDbTrack.toFixed(1)} 最大:${maxDbTrack.toFixed(1)} 平均:${(avgDbAcc/avgDbN).toFixed(1)}`;
  // Spectrogram (shift left, draw new column at right)
  const imgData = spctx.getImageData(1,0,specCanvas.width-1, specCanvas.height);
  spctx.putImageData(imgData,0,0);
  // choose dB range
  const rangeSel=document.getElementById('dbrange').value;
  let minR=40, maxR=100;
  if(rangeSel==='20-120'){ minR=20; maxR=120; }
  if(rangeSel==='auto'){ minR=Math.min(minDbTrack, 40); maxR=Math.max(maxDbTrack, 80); }
  for(let y=0;y<specCanvas.height;y++){
    // map y to frequency bin (log-ish)
    const frac = 1 - y/specCanvas.height; // high freq on top
    const bin = Math.floor(Math.pow(frac, 0.5) * (dataFreq.length-1));
    const v = dataFreq[bin]/255; // 0..1
    const vdb = 20*Math.log10(v+1e-6) + 100; // pseudo
    spctx.fillStyle = colorForDb(vdb, minR, maxR);
    spctx.fillRect(specCanvas.width-1, y, 1, 1);
  }
  rafId = requestAnimationFrame(animate);
}
document.getElementById('btnMic').onclick=startMic;
document.getElementById('btnMicStop').onclick=stopMic;

// ====== GPS & land ======
document.getElementById('btnGPS').onclick=()=>{
  if(!navigator.geolocation) { alert('Geolocation未対応'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    document.getElementById('gpsOut').textContent = `緯度:${latitude.toFixed(6)} 経度:${longitude.toFixed(6)}`;
  }, err=> alert('位置取得失敗: '+err.message));
};
document.getElementById('btnThree').onclick=()=>{
  const a=Number(document.getElementById('rosenka').value||0);
  const b=Number(document.getElementById('koji').value||0);
  const c=Number(document.getElementById('nearby').value||0);
  const avg = (a+b+c)/3;
  document.getElementById('avgOut').textContent = '3点平均: '+ (isFinite(avg)? avg.toFixed(1):'-');
  const priceMan=Number(document.getElementById('priceMan').value||0);
  const area=Number(document.getElementById('landArea').value||0);
  if(priceMan>0 && area>0 && avg>0){
    const landValue = avg*area/1000; // 千円/㎡ × ㎡ → 千円 → 万円
    const ratio = (landValue/priceMan)*100;
    document.getElementById('ratioOut').textContent = '土地値比率: ' + ratio.toFixed(1) + '%';
  }else{
    document.getElementById('ratioOut').textContent = '土地値比率: -';
  }
};

// ====== DSCR ======
document.getElementById('opexPreset').addEventListener('change',(e)=>{
  document.getElementById('opex').value = e.target.value;
});
document.getElementById('btnDSCR').onclick=()=>{
  const rent=Number(document.getElementById('rent').value||0);
  const occ=Number(document.getElementById('occ').value||0);
  const opex=Number(document.getElementById('opex').value||0);
  const fixed=Number(document.getElementById('fixed').value||0);
  const loan=Number(document.getElementById('loan').value||0);
  const rate=Number(document.getElementById('rate').value||0);
  const years=Number(document.getElementById('years').value||0);
  const eg=rent*12*occ;
  const noi=eg*(1-opex) - fixed;
  const r = rate/12;
  const n = years*12;
  const pmt = r===0? loan/n : loan*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
  const annual = pmt*12;
  const dscr = noi/annual;
  document.getElementById('nois').textContent='NOI: '+Math.round(noi).toLocaleString();
  document.getElementById('debt').textContent='年返済: '+Math.round(annual).toLocaleString();
  document.getElementById('dscrOut').textContent='DSCR: '+(isFinite(dscr)? dscr.toFixed(2):'-')+(dscr>=1.0?'（良好）':'（要検討）');
};

// ====== Check list ======
const checklist = [
  ['外壁・屋根雨漏り','良',0,'箇所',50000],
  ['室内壁/天井(汚れ/剥がれ/カビ)','良',0,'㎡',1500],
  ['床(傷/沈み/床鳴り)','良',0,'㎡',8000],
  ['水回り(キッチン/浴室/洗面/トイレ)','良',0,'式',30000],
  ['建具/サッシ/網戸','良',0,'箇所',5000],
  ['電気/分電盤/照明','良',0,'式',15000],
  ['給湯器/配管','良',0,'式',80000],
  ['バルコニー/共用部','良',0,'式',10000]
];
function renderChecklist(){
  const tb=document.querySelector('#chkTable tbody'); tb.innerHTML='';
  checklist.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${it[0]}</td>
      <td><select data-i="${i}" class="jud"><option>良</option><option>注意</option><option>要修繕</option></select></td>
      <td><input data-i="${i}" class="qty" type="number" step="0.1" value="${it[2]}" style="width:80px"></td>
      <td>${it[3]}</td>
      <td><input data-i="${i}" class="unit" type="number" step="100" value="${it[4]}" style="width:100px"></td>
      <td class="amt">0</td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('.jud').forEach(sel=>sel.addEventListener('change', recalc));
  tb.querySelectorAll('.qty').forEach(inp=>inp.addEventListener('input', recalc));
  tb.querySelectorAll('.unit').forEach(inp=>inp.addEventListener('input', recalc));
  recalc();
}
function recalc(){
  let sum=0;
  document.querySelectorAll('#chkTable tbody tr').forEach((tr,idx)=>{
    const qty=parseFloat(tr.querySelector('.qty').value||'0');
    const unit=parseFloat(tr.querySelector('.unit').value||'0');
    const amt=Math.round(qty*unit);
    tr.querySelector('.amt').textContent=amt.toLocaleString();
    sum+=amt;
  });
  document.getElementById('chkSum').textContent = sum.toLocaleString();
}
renderChecklist();

// ====== Save / Report ======
document.getElementById('btnSaveImage').onclick=()=>{
  const a=document.createElement('a');
  a.href = stageCanvas.toDataURL('image/png');
  a.download='staging.png'; a.click();
};
document.getElementById('btnSaveReport').onclick=()=>{
  const html = `<!doctype html><meta charset="utf-8"><title>内見レポート</title>
    <style>body{font-family:sans-serif;padding:16px} h2{border-bottom:1px solid #ccc}</style>
    <h1>内見レポート</h1>
    <h2>ステージング画像</h2>
    <img src="${stageCanvas.toDataURL('image/png')}" style="max-width:100%">
    <h2>土地値比率</h2>
    <p>${document.getElementById('avgOut').textContent} / ${document.getElementById('ratioOut').textContent}</p>
    <h2>DSCR</h2>
    <p>${document.getElementById('nois').textContent}、${document.getElementById('debt').textContent}、${document.getElementById('dscrOut').textContent}</p>
    <h2>チェック概算</h2>
    <p>合計: ${document.getElementById('chkSum').textContent} 円</p>`;
  const blob=new Blob([html],{type:'text/html'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='report.html'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
};
document.getElementById('btnSaveState').onclick=()=>{
  const state={
    scalePxPerM, style:document.getElementById('styleSel').value,
    priceMan:document.getElementById('priceMan').value, landArea:document.getElementById('landArea').value,
    rosenka:document.getElementById('rosenka').value, koji:document.getElementById('koji').value, nearby:document.getElementById('nearby').value
  };
  localStorage.setItem('naiken_state', JSON.stringify(state));
  alert('保存しました');
};
document.getElementById('btnLoadState').onclick=()=>{
  const s=localStorage.getItem('naiken_state'); if(!s) {alert('保存データがありません'); return;}
  try{
    const st=JSON.parse(s);
    scalePxPerM=st.scalePxPerM||null;
    document.getElementById('styleSel').value=st.style||document.getElementById('styleSel').value;
    ['priceMan','landArea','rosenka','koji','nearby'].forEach(id=>{ if(st[id]!=null) document.getElementById(id).value=st[id]; });
    if(scalePxPerM) scaleBadge.textContent='スケール設定: 1m ≒ '+scalePxPerM.toFixed(1)+' px';
  }catch(e){ alert('復元に失敗'); }
};
</script>
</body>
</html>
