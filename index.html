<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>内見サポート：ステージング＋計測＋土地値比率</title>
<style>
  :root{--bg:#0e1930;--panel:#0f223e;--text:#e7eefc;--accent:#3ec4ff;--warn:#ffae00;}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}
  h2{margin:16px 12px 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn, label.file-btn{background:#152b4d;border:1px solid #2c4d80;color:var(--text);padding:8px 10px;border-radius:10px}
  .btn:active{transform:translateY(1px)}
  label.file-btn input{display:none}
  select,input[type=number],input[type=text]{background:#0e1f3a;color:var(--text);border:1px solid #2b4577;border-radius:8px;padding:6px 8px}
  .card{background:var(--panel);border:1px solid #223a66;border-radius:14px;margin:12px;padding:12px}
  .hint{font-size:12px;opacity:.8}
  .flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .w100{width:100%}
  .canvas-wrap{position:relative; border-radius:12px; overflow:hidden; background:#000}
  canvas#stage{width:100%; touch-action:none; display:block}
  .badge{display:inline-block;background:#18345f;border:1px solid #2a578f;border-radius:10px;padding:4px 8px;margin-left:6px;font-size:12px}
  .pill{background:#18345f;border:1px solid #2a578f;border-radius:999px;padding:4px 10px}
  .table{width:100%;border-collapse:collapse;font-size:14px}
  .table th,.table td{border-top:1px solid #26436f;padding:6px 8px}
  .ghost{pointer-events:none} /* 枠などはクリックを奪わない */
  .right{margin-left:auto}
  .warn{color:var(--warn)}
  .small{font-size:12px}
</style>
</head>
<body>

<!-- ① カメラ／写真 -->
<section class="card">
  <h2>① カメラ／写真 <span id="envBadge" class="badge">HTTPS: ? / UA: ?</span></h2>
  <div class="row">
    <button class="btn" id="btnBack">背面で起動</button>
    <button class="btn" id="btnFront">前面で起動</button>
    <button class="btn" id="btnShoot">撮影</button>
    <label class="file-btn"><input type="file" id="photoPicker" accept="image/*">写真を選択</label>
    <span class="pill">向き
      <select id="selFacing">
        <option value="environment">背面</option>
        <option value="user">前面</option>
      </select>
    </span>
    <span class="pill">ズーム <input id="rngZoom" type="range" min="1" max="5" step="0.1" value="1"></span>
    <button class="btn" id="btnTorch">ライト</button>
    <span class="right small">※HTTPSのみカメラ可。GitHub PagesはOK</span>
  </div>

  <div class="canvas-wrap">
    <video id="video" playsinline muted style="display:none"></video>
    <canvas id="stage" width="1280" height="720"></canvas>
  </div>

  <div class="row">
    <span class="pill">明るさ <input id="rngBri" type="range" min="0.2" max="2" step="0.05" value="1"></span>
    <span class="pill">コントラスト <input id="rngCon" type="range" min="0.5" max="2" step="0.05" value="1"></span>
    <button class="btn" id="btnAuto">自動補正</button>
    <button class="btn right" id="btnSave">完成画像を保存</button>
  </div>
  <div class="hint">撮影 or 写真選択でキャンバス固定。カメラは起動中のみ自動描画します。</div>
</section>

<!-- ② 基準2点・実寸 -->
<section class="card">
  <h2>② 基準2点・実寸</h2>
  <div class="row">
    <button class="btn" id="btnBase2">基準2点モード</button>
    <span>基準長さ <input id="inpBaseLen" type="number" step="0.01" value="2.00" style="width:90px"> m</span>
    <span class="badge">1m ≒ <span id="pxpm">-</span> px</span>
    <span class="hint">キャンバス上を2回タップで決定</span>
  </div>
</section>

<!-- ③ ステージング（矩形家具） -->
<section class="card">
  <h2>③ ステージング（ドラッグ／自動配置／削除はダブルタップ）</h2>
  <div class="row">
    <button class="btn" data-add="ソファ"  data-w="1.8" data-d="0.8">ソファ</button>
    <button class="btn" data-add="テーブル" data-w="1.2" data-d="0.6">テーブル</button>
    <button class="btn" data-add="ベッド"  data-w="2.0" data-d="1.0">ベッド</button>
    <button class="btn" data-add="観葉"  data-w="0.6" data-d="0.6">観葉</button>
    <button class="btn" id="btnAutoPlace">クイック自動配置</button>
    <button class="btn" id="btnClear">クリア</button>
    <span class="hint">※将来は画像スプライトへ差替可。今は矩形で位置検討。</span>
  </div>

  <table class="table" id="tbl">
    <thead><tr><th>#</th><th>名称</th><th>幅(m)</th><th>奥行(m)</th><th>削除</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ④ 物件情報・土地値比率 -->
<section class="card">
  <h2>④ 物件情報・土地値比率</h2>
  <div class="flex">
    <span>物件価格(万円) <input id="priceMan" type="number" placeholder="1980" style="width:100px"></span>
    <span>住所 <input id="addr" type="text" placeholder="住所を入力/貼付け" class="w100" style="min-width:280px"></span>
    <button class="btn" id="btnGPS">GPSで追記</button>
  </div>
  <div class="flex" style="margin-top:6px">
    <span>路線価(千円/m²) <input id="rosenka" type="number" style="width:110px"></span>
    <span>公示(千円/m²) <input id="kouji" type="number" style="width:110px"></span>
    <span>近傍(千円/m²) <input id="kinbo" type="number" style="width:110px"></span>
    <button class="btn" id="btnAvg">3点平均</button>
  </div>
  <div class="flex" style="margin-top:6px">
    <span>土地面積(㎡) <input id="landArea" type="number" style="width:120px"></span>
    <button class="btn" id="btnRatio">土地値比率</button>
  </div>
  <pre id="landOut" class="w100" style="min-height:54px"></pre>
  <div class="hint">注：自動取得APIはCORS/鍵の制約があるため、現段階はUI＋計算を内蔵。将来はクラウド関数経由で路線価等を自動取得に拡張。</div>
</section>

<!-- フッタ -->
<section class="card small">
  <div>Tips: キャンバス外に家具が出ないよう <b>クランプ</b> 実装済み。基準2点クリックはオーバーレイを <b>pointer-events:none</b> にし、<b>passive:false</b> で干渉排除。</div>
</section>

<script>
/* ========== 環境表示 ========== */
const envBadge = document.getElementById('envBadge');
envBadge.textContent = `HTTPS:${location.protocol==='https:'?'OK':'NG'} / UA:${/Mobi|Android|iPhone/.test(navigator.userAgent)?'Mobile':'Desktop'}`;

/* ========== 共有DOM ========== */
const video = document.getElementById('video');
const cvs   = document.getElementById('stage');
const ctx   = cvs.getContext('2d', { willReadFrequently:true });

/* ========== カメラ／写真 ========== */
let stream=null, vTrack=null, rafId=null;
let bri=1, con=1;
let baseBitmap=null; // 写真 or 撮影結果を保持（描画のベース）
let torchOn=false;

function applyFilters(){
  ctx.filter = `brightness(${bri}) contrast(${con})`;
}

function drawLoopFromVideo(){
  cancelAnimationFrame(rafId);
  const loop = ()=>{
    if (video.readyState>=2){
      if (cvs.width!==video.videoWidth || cvs.height!==video.videoHeight){
        cvs.width  = video.videoWidth || 1280;
        cvs.height = video.videoHeight || 720;
      }
      applyFilters();
      ctx.drawImage(video,0,0,cvs.width,cvs.height);
    }
    rafId = requestAnimationFrame(loop);
  };
  rafId = requestAnimationFrame(loop);
}

async function startCam(facing='environment'){
  stopStream();
  const zoom = +document.getElementById('rngZoom').value || 1;
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal:facing },
        width:{ideal:1280}, height:{ideal:720},
        advanced:[{ zoom: zoom }]
      },
      audio:false
    });
    vTrack = stream.getVideoTracks()[0];
    video.srcObject = stream;
    await video.play();
    baseBitmap=null; // ライブ映像優先
    drawLoopFromVideo();
  }catch(e){
    alert('カメラ起動に失敗しました: '+e.message);
  }
}

function stopStream(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  cancelAnimationFrame(rafId);
}

document.getElementById('btnBack').onclick = ()=> startCam('environment');
document.getElementById('btnFront').onclick= ()=> startCam('user');
document.getElementById('selFacing').onchange = e=> startCam(e.target.value);

document.getElementById('rngZoom').oninput = async e=>{
  const z = +e.target.value;
  if(vTrack && vTrack.applyConstraints){
    try{ await vTrack.applyConstraints({ advanced:[{ zoom:z }] }); }
    catch{ /* 非対応端末は無視 */ }
  }
};

document.getElementById('btnTorch').onclick = async()=>{
  torchOn = !torchOn;
  if(!vTrack){ alert('カメラ起動後に使用できます'); return; }
  const caps = vTrack.getCapabilities?.() || {};
  if('torch' in caps){
    try{ await vTrack.applyConstraints({ advanced:[{ torch: torchOn }] }); }
    catch{ alert('ライト未対応の端末です'); }
  }else{
    alert('ライト未対応の端末です');
  }
};

document.getElementById('btnShoot').onclick = async ()=>{
  if(!video.srcObject){ alert('カメラを起動してください'); return; }
  applyFilters();
  ctx.drawImage(video,0,0,cvs.width,cvs.height);
  const blob = await new Promise(r=> cvs.toBlob(r,'image/png',0.92));
  baseBitmap = await createImageBitmap(blob);
  stopStream();
  render();
};

document.getElementById('photoPicker').onchange = async e=>{
  const f = e.target.files[0]; if(!f) return;
  baseBitmap = await createImageBitmap(f);
  cvs.width  = baseBitmap.width; cvs.height = baseBitmap.height;
  render();
};

document.getElementById('rngBri').oninput = e=>{ bri = +e.target.value; render(); };
document.getElementById('rngCon').oninput = e=>{ con = +e.target.value; render(); };
document.getElementById('btnAuto').onclick = ()=>{ bri=1.1; con=1.15; document.getElementById('rngBri').value=bri; document.getElementById('rngCon').value=con; render(); };

document.getElementById('btnSave').onclick = ()=>{
  render();
  const a = document.createElement('a');
  a.href = cvs.toDataURL('image/png');
  a.download = `staging_${Date.now()}.png`;
  a.click();
};

/* ========== 基準2点・実寸 ========== */
let baseMode=false, basePts=[];
let pxPerMeter = 0; // 1mあたりpx

const pxpmSpan = document.getElementById('pxpm');
document.getElementById('btnBase2').onclick = ()=>{ baseMode=true; basePts=[]; alert('キャンバス上で基準の2点を順にタップしてください'); };

function canvasXY(evt){
  const r = cvs.getBoundingClientRect();
  return {
    x: (evt.clientX - r.left) * (cvs.width / r.width),
    y: (evt.clientY - r.top)  * (cvs.height/ r.height)
  };
}

cvs.addEventListener('pointerdown', (e)=>{
  e.preventDefault(); // スクロールに奪われない
  const p = canvasXY(e);
  if(baseMode){
    basePts.push(p);
    ctx.save(); applyFilters();
    if(baseBitmap) ctx.drawImage(baseBitmap,0,0,cvs.width,cvs.height);
    ctx.fillStyle='#3ec4ff88'; ctx.beginPath(); ctx.arc(p.x,p.y,8,0,Math.PI*2); ctx.fill(); ctx.restore();
    if(basePts.length===2){
      const dx = basePts[0].x - basePts[1].x;
      const dy = basePts[0].y - basePts[1].y;
      const pix = Math.hypot(dx,dy);
      const meters = +document.getElementById('inpBaseLen').value || 1;
      pxPerMeter = pix / meters;
      pxpmSpan.textContent = pxPerMeter.toFixed(1);
      basePts=[]; baseMode=false;
      render();
    }
  }
},{passive:false});

/* ========== ステージング（家具） ========== */
const tblBody = document.querySelector('#tbl tbody');
const addBtns = document.querySelectorAll('button[data-add]');
const furns = []; // {id,label,x,y,w_m,d_m}

function m2px(m){ return (pxPerMeter>0? m*pxPerMeter : m*80); } // 基準未設定時は暫定80px/m
function clamp(v,min,max){ return Math.min(Math.max(v,min),max); }

function render(){
  ctx.save(); applyFilters();
  if(baseBitmap){ ctx.drawImage(baseBitmap,0,0,cvs.width,cvs.height); }
  else if(video.readyState>=2){ ctx.drawImage(video,0,0,cvs.width,cvs.height); }
  else { ctx.clearRect(0,0,cvs.width,cvs.height); }
  ctx.restore();

  // 家具
  ctx.lineWidth = 2;
  furns.forEach(f=>{
    const w = m2px(f.w_m), h = m2px(f.d_m);
    // はみ出し防止
    f.x = clamp(f.x ?? 16, 0, cvs.width  - w - 1);
    f.y = clamp(f.y ?? (cvs.height - h - 16), 0, cvs.height - h - 1);

    ctx.fillStyle = 'rgba(0,255,136,0.25)';
    ctx.strokeStyle = '#00ff88';
    ctx.fillRect(f.x, f.y, w, h);
    ctx.strokeRect(f.x, f.y, w, h);

    ctx.fillStyle='#001b11cc';
    ctx.fillRect(f.x, f.y-20, 70,18);
    ctx.fillStyle='#fff';
    ctx.font='12px system-ui';
    ctx.fillText(f.label, f.x+6, f.y-7);
  });

  // 基準2点ガイド（モード中）
  if(baseMode && basePts[0]){
    ctx.strokeStyle='#3ec4ff';
    ctx.setLineDash([6,6]);
    ctx.beginPath(); ctx.moveTo(basePts[0].x, basePts[0].y); ctx.lineTo(basePts[0].x, basePts[0].y); ctx.stroke();
    ctx.setLineDash([]);
  }
}

addBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    const f = { id:Date.now()+Math.random(), label:b.dataset.add, w_m:+b.dataset.w, d_m:+b.dataset.d, x:undefined, y:undefined };
    furns.push(f); addRow(f); autoPlace([f]); render();
  });
});

function addRow(f){
  const tr = document.createElement('tr'); tr.dataset.id=f.id;
  tr.innerHTML = `<td></td><td>${f.label}</td>
    <td><input type="number" step="0.1" value="${f.w_m}" style="width:80px"></td>
    <td><input type="number" step="0.1" value="${f.d_m}" style="width:80px"></td>
    <td><button class="btn small">削除</button></td>`;
  tblBody.appendChild(tr);
  renumber();

  tr.querySelectorAll('input')[0].oninput = e=>{ f.w_m=+e.target.value||f.w_m; render(); };
  tr.querySelectorAll('input')[1].oninput = e=>{ f.d_m=+e.target.value||f.d_m; render(); };
  tr.querySelector('button').onclick = ()=>{
    const i = furns.findIndex(x=>x.id===f.id); if(i>=0) furns.splice(i,1);
    tr.remove(); renumber(); render();
  };
}
function renumber(){ [...tblBody.children].forEach((tr,i)=> tr.firstChild.textContent = i+1 ); }

function autoPlace(target=furns){
  // 下辺に均等配置（はみ出し防止つき）
  const margin = 16;
  let x = margin;
  target.forEach(f=>{
    const w = m2px(f.w_m), h = m2px(f.d_m);
    if(x + w + margin > cvs.width) x = margin;
    f.x = x; f.y = cvs.height - h - margin;
    x += w + margin;
  });
  render();
}
document.getElementById('btnAutoPlace').onclick = ()=> autoPlace();
document.getElementById('btnClear').onclick = ()=>{ furns.length=0; tblBody.innerHTML=''; render(); };

/* ドラッグ＆ダブルタップ削除 */
let dragId=null, dragOff={x:0,y:0}, lastTap=0;
cvs.addEventListener('pointerdown',(e)=>{
  e.preventDefault();
  const r = cvs.getBoundingClientRect();
  const p = {x:(e.clientX-r.left)*(cvs.width/r.width), y:(e.clientY-r.top)*(cvs.height/r.height)};
  const hit = furns.findLast(f=>{
    const w=m2px(f.w_m), h=m2px(f.d_m);
    return p.x>=f.x && p.x<=f.x+w && p.y>=f.y && p.y<=f.y+h;
  });
  const now=Date.now();
  if(hit && (now-lastTap)<300){
    const i = furns.findIndex(x=>x.id===hit.id);
    if(i>=0){ furns.splice(i,1); [...tblBody.children][i]?.remove(); renumber(); render(); }
    lastTap=0; return;
  }
  lastTap=now;

  if(hit){ dragId=hit.id; dragOff.x=p.x-hit.x; dragOff.y=p.y-hit.y; }
},{passive:false});
cvs.addEventListener('pointermove',(e)=>{
  if(dragId==null) return;
  const f = furns.find(x=>x.id===dragId); if(!f) return;
  const r = cvs.getBoundingClientRect();
  const p = {x:(e.clientX-r.left)*(cvs.width/r.width), y:(e.clientY-r.top)*(cvs.height/r.height)};
  const w=m2px(f.w_m), h=m2px(f.d_m);
  f.x = Math.min(Math.max(p.x - dragOff.x, 0), cvs.width - w - 1);
  f.y = Math.min(Math.max(p.y - dragOff.y, 0), cvs.height - h - 1);
  render();
});
cvs.addEventListener('pointerup',()=>{ dragId=null; });

/* ========== 土地：3点平均＆比率 ========== */
function threeAvg(){
  const r = +document.getElementById('rosenka').value || 0;
  const k = +document.getElementById('kouji').value  || 0;
  const n = +document.getElementById('kinbo').value  || 0;
  const roJikka = r ? r*1.25 : 0;
  const arr = [roJikka,k,n].filter(v=>v>0);
  const avg = arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
  return {avg, roJikka};
}
document.getElementById('btnAvg').onclick = ()=>{
  const {avg, roJikka} = threeAvg();
  landOut.textContent = `路線価×1.25: ${roJikka.toFixed(1)} / 三点平均: ${avg.toFixed(1)} 千円/m²`;
};
document.getElementById('btnRatio').onclick = ()=>{
  const {avg} = threeAvg();
  const area = +document.getElementById('landArea').value||0;
  const man  = +document.getElementById('priceMan').value||0;
  const landValMan = avg * area / 1000; // 千円/m²×㎡→千円→万円
  const ratio = man>0 ? (landValMan / man)*100 : 0;
  landOut.textContent = `三点平均: ${avg.toFixed(1)} 千円/m²\n土地評価(概算): ${landValMan.toFixed(0)} 万円\n土地値比率: ${ratio.toFixed(1)} %`;
};
document.getElementById('btnGPS').onclick = ()=>{
  if(!navigator.geolocation){ alert('この端末はGPSに非対応です'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const s = `（緯度${pos.coords.latitude.toFixed(6)}, 経度${pos.coords.longitude.toFixed(6)}）`;
    const a = document.getElementById('addr');
    a.value = a.value ? a.value + ' ' + s : s;
  }, err=> alert('GPS取得に失敗: '+err.message));
};

/* 初回描画 */
render();
</script>
</body>
</html>
