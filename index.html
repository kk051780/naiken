<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>不動産・内見 Suite v8.7-complete-07（Chat-First/全部入り）</title>
<style>
:root{--bg:#0b1524;--panel:#0f1f36;--border:#1e3a66;--txt:#e6f0ff;--hint:#cfe2ff;--pri:#3b82f6;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--mut:#9fb7da}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:1000;background:rgba(11,21,36,.9);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--border)}
.headwrap{display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;padding:.6rem}.brand{font-weight:700}.ver{color:var(--mut);font-size:.85rem}
nav{display:flex;gap:.4rem;flex-wrap:wrap}.btn{background:#12284a;border:1px solid var(--border);color:var(--txt);padding:.45rem .7rem;border-radius:.6rem;cursor:pointer}
.btn.primary{background:var(--pri);border-color:#2563eb}.btn:disabled{opacity:.5;cursor:not-allowed}
.in,.sl,textarea{background:#0c1728;border:1px solid var(--border);color:var(--txt);padding:.5rem;border-radius:.6rem;width:100%}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:.9rem;padding:.9rem;margin:.9rem}
.grid{display:grid;gap:.6rem}.cols-2{grid-template-columns:1fr 1fr}.cols-3{grid-template-columns:1fr 1fr 1fr}
.row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}.hint{color:var(--hint);font-size:.9rem}
.badge{padding:.2rem .5rem;border:1px solid var(--border);border-radius:.5rem;background:#10213a;color:#cfe2ff}
.label{display:inline-block;background:#1a355a;border:1px solid #294f80;border-radius:.5rem;padding:.1rem .45rem;margin-right:.3rem}
.table{width:100%;border-collapse:collapse}.table th,.table td{border-bottom:1px solid #173055;padding:.5rem .6rem;vertical-align:top}
.table thead th{position:sticky;top:120px;background:#0f1f36;z-index:3}
.mbar{height:8px;border:1px solid #203c63;border-radius:6px;background:#0d1a2a;overflow:hidden}.mbar>i{display:block;height:100%;background:#29b6f6}
.mbar.k>i{background:#10b981}.mbar.d>i{background:#f59e0b}.tag{display:inline-block;margin:.1rem .2rem;padding:.08rem .4rem;border:1px solid #345a8e;border-radius:.6rem;background:#1a3456}
.good{color:var(--ok)} .bad{color:var(--bad)} .mut{color:var(--mut)} .tabs button{white-space:nowrap} section[hidden]{display:none!important}
canvas{max-width:100%;border:1px solid #173055;border-radius:.6rem;background:#000} #camVideo{width:100%;border:1px solid #173055;border-radius:.6rem;background:#000}
.overlay{position:absolute;inset:0;pointer-events:none}.stageWrap{position:relative}
.toolbar{position:sticky;bottom:0;z-index:900;display:flex;gap:.4rem;flex-wrap:wrap;background:rgba(15,31,54,.92);padding:.5rem;border-top:1px solid var(--border)}
.noiseRow{display:grid;grid-template-columns:1fr;gap:.6rem} @media(min-width:900px){ .noiseRow{grid-template-columns:1fr 1fr} .cols-3{grid-template-columns:1fr 1fr 1fr} .cols-2{grid-template-columns:1fr 1fr} }
.noiseCamWrap{position:relative;min-height:360px;border:1px solid #173055;border-radius:.6rem;overflow:hidden;background:#000}
.noiseCamWrap video{width:100%;height:100%;object-fit:cover;display:block}.noiseCamWrap canvas{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}

/* Chat SNS style */
.chatlog{height:360px;overflow:auto;border:1px solid #173055;border-radius:.9rem;background:#0c1728;padding:.6rem}
.im{display:flex;gap:.5rem;margin:.35rem 0;align-items:flex-end}
.im.ai{justify-content:flex-start}.im.me{justify-content:flex-end}
.bubble{max-width:78%;padding:.55rem .65rem;border-radius:1rem;position:relative;border:1px solid #274772}
.im.ai .bubble{background:#0f1f36}.im.me .bubble{background:#132846}
.avatar{width:28px;height:28px;border-radius:50%;background:#163255;border:1px solid #2a4f81;display:flex;align-items:center;justify-content:center;font-size:.8rem;color:#cfe2ff}
.meta{font-size:.78rem;color:#9fb7da;margin:0 .4rem}
.typing{display:inline-block;width:36px;height:12px;background:linear-gradient(90deg,#1b2f50 0,#294f80 50%,#1b2f50 100%);border-radius:6px;animation:ty 1.2s infinite}
@keyframes ty{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
.quick{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.3rem}
.quick .btn{background:#11325d}

/* YouTube Dock */
.ytDock{position:fixed;left:0;right:0;bottom:0;z-index:800;background:rgba(10,17,32,.96);border-top:1px solid #173055;padding:.45rem .5rem;overflow-x:auto;display:flex;gap:.5rem;align-items:center}
.ytChip{flex:0 0 auto;width:176px;aspect-ratio:16/9;border-radius:.6rem;overflow:hidden;border:1px solid #173055;background:#0f1f36;position:relative}
.ytChip img{width:100%;height:100%;object-fit:cover;display:block}
.ytCap{position:absolute;left:0;right:0;bottom:0;font-size:.78rem;color:#cfe2ff;background:linear-gradient(transparent,rgba(0,0,0,.6));padding:.25rem .35rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ytToggle{position:fixed;right:.6rem;bottom:110px;z-index:810;background:#11325d;border:1px solid #1e3a66;color:#e6f0ff;padding:.4rem .6rem;border-radius:.6rem}
@media(max-width:560px){.ytChip{width:148px}.ytToggle{bottom:104px}}
.card{border:1px solid #173055;background:#0f1f36;border-radius:.9rem;overflow:hidden}
.card img{display:block;width:100%;height:160px;object-fit:cover}.card .cbody{padding:.6rem}.card .ctitle{font-weight:600;margin:.2rem 0}
</style>
</head>
<body>
<header>
  <div class="headwrap">
    <div class="brand">内見・ステージング Suite</div>
    <div class="ver">v8.7-complete-07</div>
    <nav class="tabs">
      <button class="btn primary" data-tab="chat">チャット</button>
      <button class="btn" data-tab="stage">ステージング</button>
      <button class="btn" data-tab="floor">間取り</button>
      <button class="btn" data-tab="noise">騒音</button>
      <button class="btn" data-tab="rank">ランキング</button>
      <button class="btn" data-tab="loan">融資レーダー</button>
      <button class="btn" data-tab="inspect">内見チェック</button>
      <button class="btn" data-tab="finance">評価/資金</button>
      <button class="btn" data-tab="videos">動画</button>
      <button class="btn" id="saveAll">保存</button>
      <button class="btn" id="loadAll">復元</button>
    </nav>
  </div>
</header>

<main>
  <!-- 0) チャット -->
  <section id="tab-chat" class="panel">
    <h2>会話アシスタント（メイン）</h2>
    <div id="chatLog" class="chatlog"></div>
    <div class="row" style="margin-top:.5rem">
      <input id="chatInput" class="in" placeholder="例）ランキングしたい / 内見を始めたい / HTML貼るね…">
      <button class="btn primary" id="chatSend">送信</button>
    </div>
    <div class="row" style="margin-top:.3rem">
      <button class="btn" data-cq="ランキング">ランキング</button>
      <button class="btn" data-cq="内見">内見</button>
      <button class="btn" data-cq="ステージング">ステージング</button>
      <button class="btn" data-cq="騒音">騒音</button>
      <button class="btn" data-cq="動画">動画</button>
      <button class="btn" data-cq="住所取得">住所取得</button>
      <button class="btn" data-cq="ヘルプ">ヘルプ</button>
    </div>
  </section>

  <!-- 1) ステージング -->
  <section id="tab-stage" class="panel" hidden>
    <h2>① ステージング（写真/カメラ・部屋解析・家具360擬似・自動配置）</h2>
    <div class="grid cols-2">
      <div>
        <div class="row">
          <input type="file" id="pickImg" accept="image/*" class="in">
          <button class="btn" id="useCam">カメラ起動</button>
          <button class="btn" id="snap">撮影</button>
          <button class="btn" id="useCamNative">ネイティブ撮影（代替）</button>
          <input type="file" id="nativeShot" accept="image/*" capture="environment" style="display:none">
        </div>
        <video id="camVideo" playsinline muted></video>

        <div class="stageWrap" style="margin-top:.6rem">
          <canvas id="stageCanvas" width="960" height="540"></canvas>
          <canvas id="overCanvas" class="overlay" width="960" height="540"></canvas>
        </div>

        <div class="toolbar">
          <button class="btn" id="analyzeRoom">部屋解析</button>
          <select id="furnType" class="sl" style="width:9rem">
            <option value="sofa">ソファ</option><option value="table">テーブル</option><option value="bed">ベッド</option><option value="plant">観葉植物</option>
          </select>
          <label class="label">角度</label><input id="yaw" type="range" min="-60" max="60" step="1" value="0" class="sl" style="width:140px">
          <button class="btn" id="autoPlace">自動配置</button>
          <button class="btn" id="clearStage">消去</button>
          <label class="label">家具画像インポート</label><input type="file" id="furnImg" accept="image/*" class="in" style="max-width:220px">
        </div>
        <div class="hint">操作：ドラッグで移動／ピンチ（またはホイール）でサイズ／最後に置いた家具に「角度」反映。</div>
      </div>
      <div>
        <h3>部屋解析の考え方（MVP）</h3>
        <ul>
          <li>床候補＝画像下部の明度高域＋エッジ少域</li>
          <li>窓候補＝明度高域＋縦長矩形群</li>
          <li>壁＝床以外。家具は床中央→壁から適正距離へ</li>
        </ul>
        <canvas id="roomDiag" width="320" height="180"></canvas>
      </div>
    </div>
  </section>

  <!-- 2) 間取り -->
  <section id="tab-floor" class="panel" hidden>
    <h2>② 間取り（多角形 + 2点スケール校正）</h2>
    <div class="grid cols-2">
      <div>
        <canvas id="planCanvas" width="640" height="480"></canvas>
        <div class="toolbar">
          <button class="btn" id="addVertex">頂点追加</button>
          <button class="btn" id="closePoly">面を確定</button>
          <button class="btn" id="scale2pt">2点スケール</button>
          <span class="hint" id="planMsg">点をクリックして多角形を作成。</span>
        </div>
      </div>
      <div>
        <div class="row">
          <label class="badge">実寸スケール(m/px)</label><input id="scaleVal" class="in" style="width:8rem" value="0">
          <label class="badge">面積</label><span id="areaVal" class="hint">0.00 m²</span>
        </div>
        <div class="hint">スケール：2点クリック→実距離(m)入力→m/px自動設定。</div>
      </div>
    </div>
  </section>

  <!-- 3) 騒音 -->
  <section id="tab-noise" class="panel" hidden>
    <h2>③ 騒音（波形＋時間FFTスペクトログラム＋スキャン型音源可視化）</h2>
    <div class="noiseRow">
      <div>
        <div class="row">
          <button class="btn" id="micStart">計測開始</button>
          <button class="btn" id="micStop">停止</button>
          <label class="label">FFT N</label><input id="fftN" type="number" class="in" value="2048" style="width:6rem">
          <label class="label">dBレンジ</label><input id="dbMin" type="number" class="in" value="-90" style="width:6rem">
          <input id="dbMax" type="number" class="in" value="-30" style="width:6rem">
        </div>
        <canvas id="wave" width="640" height="120"></canvas>
        <canvas id="spec" width="640" height="240"></canvas>
        <div class="hint">縦=周波数（低→高）、横=時間、濃いほどレベル高。</div>
      </div>
      <div>
        <h3>音響スキャン（カメラ + ヒートマップ）</h3>
        <div class="noiseCamWrap">
          <video id="micCam" playsinline muted></video>
          <canvas id="micHeat"></canvas>
        </div>
        <div class="row" style="margin-top:.4rem">
          <button class="btn" id="scanStart">スキャン開始</button>
          <button class="btn" id="scanStop">終了</button>
          <span class="hint">端末をゆっくり動かすと、強い方向ほど濃く蓄積されます。</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 4) ランキング -->
  <section id="tab-rank" class="panel" hidden>
    <h2>④ 土地値ランキング（貼付→プレビュー→反映→生成 / 順応サンプリング）</h2>

    <div class="panel">
      <h3>順応サンプリング抽出（試験的）</h3>
      <div class="hint">CORS許可/公開データのみ自動取得。不可サイトは「HTML貼付」へ誘導します。</div>
      <div class="row">
        <button class="btn" id="harvestNext">次のURLを抽出する</button>
        <span class="hint" id="harvestMsg">未実行</span>
      </div>
      <table class="table" id="harvestTbl">
        <thead><tr><th>ソース</th><th>URL</th><th>α/β</th><th>結果</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div class="panel">
      <h3>サイト抽出（HTML貼付 → プレビュー → CSVへ反映）</h3>
      <textarea id="htmlPaste" rows="6" class="sl" placeholder="一覧ページのHTML全体を貼付"></textarea>
      <div class="row" style="margin-top:.4rem">
        <button class="btn" id="previewHtml">プレビュー</button>
        <button class="btn primary" id="reflectBtn" disabled>CSVへ反映</button>
        <span class="hint" id="ingestMsg">未解析</span>
      </div>
      <table class="table" id="extractPreview">
        <thead><tr><th>#</th><th>住所</th><th style="text-align:right">価格(万)</th><th style="text-align:right">面積(m²)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <details class="panel">
      <summary class="btn">▼ 上級者向け：入力CSV（住所, 価格(万), 面積）を直接編集</summary>
      <textarea id="csv" rows="5" class="sl"></textarea>
      <div class="row"><label class="badge">閾値: 路/代 ≥ <span id="thrVal">0.80</span></label>
        <input id="thr" type="range" min="0.50" max="1.00" step="0.01" value="0.80" class="sl" style="width:220px">
        <button class="btn" id="loadSample">サンプル3件</button>
        <button class="btn" id="saveCsv">CSV保存</button>
      </div>
    </details>

    <div class="panel" style="overflow:auto">
      <div class="row">
        <button class="btn primary" id="runRank">ランキング生成</button>
        <span class="hint" id="rankMsg">未計算</span>
      </div>
      <table class="table" id="rankTbl">
        <thead>
          <tr>
            <th>#</th><th>住所</th>
            <th style="text-align:right">販売(万)</th>
            <th style="text-align:right">土地値(路/代,万)</th>
            <th style="text-align:right">比率(路/代)</th>
            <th style="text-align:right">土地値(公示,万)</th>
            <th style="text-align:right">比率(公)</th>
            <th style="text-align:right">近傍成約 平均(万)</th>
            <th style="text-align:right">成約比率</th>
            <th style="text-align:right">駅距離(m)</th>
            <th style="text-align:right">徒歩(分)</th>
            <th style="text-align:right">DSCR</th>
            <th>エビデンス</th><th>メモ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 5) 融資レーダー -->
  <section id="tab-loan" class="panel" hidden>
    <h2>⑤ 融資レーダー（フル/オーバー抽出）</h2>
    <div class="panel">
      <h3>使い方</h3>
      <ol style="margin:.4rem 1rem">
        <li>下のテキスト欄に <b>URL</b> / <b>yt:チャンネルID</b> / <b>テキスト</b> を1行ずつ</li>
        <li>必要なら「フルのみ/オーバーのみ/LTV下限」を指定</li>
        <li><b>取得→抽出</b>を押す</li>
      </ol>
      <div class="row"><button class="btn" id="loanSample">サンプルで試す</button></div>
    </div>
    <div class="row">
      <label class="badge">フルのみ</label><input id="onlyFull" type="checkbox">
      <label class="badge">オーバーのみ</label><input id="onlyOver" type="checkbox">
      <label class="badge">LTV下限</label><input id="minLtv" type="number" min="0" max="100" value="0" class="in" style="width:6rem">
      <button class="btn primary" id="loanRun">取得→抽出</button>
    </div>
    <textarea id="loanInput" rows="5" class="sl" placeholder="URL / yt:CHANNEL_ID / 直接テキストを1行ずつ"></textarea>
    <div class="hint" id="loanMsg"></div>
    <table class="table" id="loanTbl">
      <thead><tr>
        <th>銀行/機関</th><th>種別</th><th style="text-align:right">LTV</th>
        <th style="text-align:right">金利</th><th>属性/エリア</th><th>抜粋</th><th>出典</th><th>日付</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 6) 内見チェック -->
  <section id="tab-inspect" class="panel" hidden>
    <h2>⑥ 内見チェック（会話ガイド＋撮影＋概算修繕）</h2>
    <div class="grid cols-2">
      <div>
        <select id="chkCat" class="sl">
          <option>水回り</option><option>躯体/雨漏り</option><option>床・壁・天井</option>
          <option>窓/建具</option><option>電気/設備</option><option>共用部/外構</option>
        </select>
        <div class="panel">
          <div id="chkGuide" class="hint">カテゴリのポイントがここに表示</div>
          <input type="file" accept="image/*,video/*" id="chkCap" class="in" multiple>
          <label class="label">状態</label>
          <select id="chkState" class="sl"><option>良</option><option>注意</option><option>要修繕</option></select>
          <label class="label">概算修繕(万円)</label><input id="chkCost" class="in" value="0" style="width:7rem">
          <button class="btn" id="chkAdd">記録</button>
        </div>
        <div class="row"><button class="btn" id="chkExport">レポート出力（印刷/PDF）</button></div>
      </div>
      <div>
        <table class="table"><thead><tr><th>#</th><th>カテゴリ</th><th>状態</th><th>概算(万)</th><th>メモ/ファイル</th></tr></thead><tbody id="chkTbl"></tbody></table>
        <div class="hint" id="chkSum">合計修繕費: 0 万円</div>

        <div class="panel" style="margin-top:.6rem">
          <h3>会話ガイド</h3>
          <div id="ibChat" style="height:320px;overflow:auto;border:1px solid #173055;border-radius:.6rem;padding:.6rem;background:#0c1728"></div>
          <div class="row" style="margin-top:.4rem">
            <button class="btn" data-ib="next">次へ</button>
            <button class="btn" data-ib="photo">撮影/追加</button>
            <button class="btn" data-ib="good">良</button>
            <button class="btn" data-ib="warn">注意</button>
            <button class="btn" data-ib="fix">要修繕</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 7) 評価/資金 -->
  <section id="tab-finance" class="panel" hidden>
    <h2>⑦ 住所・価格の自動取得 / 固定費・経費率プリセット / DSCR / AI査定</h2>
    <div class="grid cols-3">
      <div>
        <label>現在地から住所取得</label>
        <button class="btn" id="addrFromGps">GPS→住所</button>
        <div class="hint" id="addrMsg">未取得</div>
      </div>
      <div>
        <label>販売価格(万円)</label><input id="vPrice" class="in" value="3000">
        <label>延床(m²)</label><input id="vFloor" class="in" value="80">
      </div>
      <div>
        <label>築年数</label><input id="vAge" class="in" value="20">
        <label>構造</label><select id="vStruct" class="sl"><option>木造</option><option>S造</option><option>RC</option></select>
      </div>
    </div>
    <div class="grid cols-3" style="margin-top:.6rem">
      <div>
        <h3>賃料/稼働</h3>
        <label>月額賃料(万円)</label><input id="vRent" class="in" value="12">
        <label>稼働率(%)</label><input id="vOcc" class="in" value="95">
      </div>
      <div>
        <h3>固定費/経費率（築年プリセット）</h3>
        <div class="row"><button class="btn" id="applyPreset">プリセット適用</button><span class="hint">築年で自動入力</span></div>
        <label>固定費(万円/年)</label><input id="vFixed" class="in" value="20">
        <label>経費率(%)</label><input id="vOpex" class="in" value="25">
      </div>
      <div>
        <h3>借入</h3>
        <label>借入額(万円)</label><input id="vDebt" class="in" value="2400">
        <label>金利(%)</label><input id="vRate" class="in" value="2.0">
        <label>年数</label><input id="vYears" class="in" value="25">
      </div>
    </div>
    <div class="row" style="margin-top:.6rem">
      <button class="btn primary" id="calcDscr">DSCR計算</button>
      <span class="hint" id="finMsg">NOI/返済/DSCR を表示</span>
    </div>

    <!-- AI査定（自宅/保有） -->
    <div class="panel" style="margin-top:.8rem">
      <h3>AI査定（自宅/保有）〈MVP〉</h3>
      <div class="grid cols-3">
        <div>
          <label>住所（参考）</label><input id="avmAddr" class="in" placeholder="例: 静岡県藤枝市…">
          <label>土地面積(m²)</label><input id="avmLand" class="in" value="100">
          <label>延床面積(m²)</label><input id="avmFloor2" class="in" value="80">
        </div>
        <div>
          <label>築年(年)</label><input id="avmAge" class="in" value="20">
          <label>構造</label>
          <select id="avmStruct" class="sl"><option>木造</option><option>S造</option><option>RC</option></select>
          <label>路線価(円/m²)</label><input id="avmRosen" class="in" placeholder="自動未実装→暫定手入力">
        </div>
        <div>
          <label>近傍成約(万)①</label><input id="avmDeal1" class="in" value="">
          <label>近傍成約(万)②</label><input id="avmDeal2" class="in" value="">
          <label>近傍成約(万)③</label><input id="avmDeal3" class="in" value="">
        </div>
      </div>
      <div class="row" style="margin-top:.4rem">
        <button class="btn" id="avmCalc">査定</button>
        <button class="btn" id="avmReflect">査定→販売価格に反映</button>
        <span class="hint" id="avmMsg">路線価 or 成約があれば精度↑（将来API対応）</span>
  