<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<title>内見ユーティリティ（全部入り v8.3 単一HTML）</title>
<style>
:root{
  --bg:#0f1a2b; --panel:#12213a; --ink:#e9f1ff; --muted:#9fb3d8;
  --accent:#43b5ff; --ok:#2ac06d; --warn:#f0ad4e; --bad:#e35;
  --btn:#162845; --line:#274166;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
h1{font-size:18px;margin:12px 12px 0}
small{color:var(--muted)}
.container{padding:8px 12px 120px}
.tabs{position:sticky;top:0;z-index:10000;background:linear-gradient(#0f1a2b,#0f1a2bcc 70%,#0f1a2b00)}
.tabs .row{display:flex;gap:8px;flex-wrap:wrap;padding:10px 12px 8px}
.btn{background:var(--btn);color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:10px 14px;font-weight:600}
.btn.primary{background:var(--accent);color:#001428}
.btn.good{background:var(--ok)}
.grid{display:grid;gap:10px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
label{font-size:13px;color:var(--muted)}
input,select,textarea{background:#0b1730;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px}
input[type=number]{width:120px}
input[type=range]{width:200px}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#1a2f53;color:#cfe0ff}
.canvasWrap{position:relative;overflow:hidden;border-radius:12px;border:1px solid var(--line);background:#000}
video,canvas.img{display:block;width:100%;height:auto}
#fabShot{position:absolute;right:10px;bottom:10px;z-index:9000;border-radius:50%;width:66px;height:66px;
  background:radial-gradient(#fff 45%,#e7f5ff 46% 60%,#7ad0ff 61%);border:4px solid #0a2744;box-shadow:0 6px 18px #0006;display:none}
.guard{position:absolute;inset:0;z-index:8000;display:none;background:transparent}
.guard.on{display:block;pointer-events:auto}
.furniture{position:absolute;left:50%;top:75%;width:180px;transform:translate(-50%,-50%);touch-action:none;user-select:none;transform-origin:center;pointer-events:auto}
.furniture.drag{outline:2px dashed #7cf}
.knob{position:absolute;right:-12px;bottom:-12px;width:26px;height:26px;border-radius:50%;background:var(--accent);border:2px solid #07263e}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi .chip{background:#0a1430;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #24385d;padding:8px 6px}
footer{position:sticky;bottom:0;background:linear-gradient(#0f1a2b00,#0f1a2bE6 30%,#0f1a2b);padding:10px 12px;z-index:9999;pointer-events:none}
hr.sep{border:none;border-top:1px dashed #2a3d5f;margin:12px 0}
.hidden{display:none}
.hud{position:absolute;left:8px;top:8px;z-index:8500;display:flex;gap:6px;flex-wrap:wrap}
.hud .btn{padding:6px 8px;border-radius:10px}
#noiseControls .btn{z-index:9500;position:relative}
#heat{position:absolute;inset:0;pointer-events:none}
#video{pointer-events:none}
#tapFix{position:fixed;right:10px;bottom:90px;z-index:11000;border-radius:12px;padding:10px 12px;background:#e33;color:#fff;border:2px solid #fff}
#tapEcho{position:fixed;left:10px;bottom:90px;z-index:11000;background:#0b1730;color:#cfe0ff;border:1px solid #2c4064;border-radius:10px;padding:6px 8px;max-width:60vw}
</style>
</head>
<body>
<h1>内見ユーティリティ（全部入り v8.3） <small id="ua"></small></h1>

<div class="tabs">
  <div class="row">
    <button class="btn primary" data-tab="staging">ステージング</button>
    <button class="btn" data-tab="measure">間取り・実寸</button>
    <button class="btn" data-tab="noise">騒音/音響ホログラフィ</button>
    <button class="btn" data-tab="land">物件/土地値比率</button>
    <button class="btn" data-tab="dscr">収支/DSCR</button>
    <button class="btn" data-tab="check">内見チェック（ガイド）</button>
    <button class="btn" data-tab="save">保存</button>
  </div>
</div>

<div class="container grid">

<!-- ===== ステージング ===== -->
<section id="staging" class="panel">
  <div class="row">
    <button class="btn" id="camStart">カメラ起動</button>
    <button class="btn" id="shotTop">撮影</button>
    <button class="btn" id="pickBtn">写真を選ぶ</button><input type="file" id="fileInput" accept="image/*" class="hidden">
    <button class="btn" id="autoPlace">家具 自動配置</button>
    <button class="btn" id="clearFurn">家具 クリア</button>
    <span id="scaleBadge" class="badge">スケール未設定</span>
  </div>
  <div class="row">
    <label>基準長さ(m)</label><input type="number" id="baseLen" min="0.1" step="0.1" value="2.0">
    <button class="btn" id="set2pt">確定（基準2点）</button>
    <label>Yaw</label><input type="range" id="yaw" min="-180" max="180" value="0">
    <label>Pitch</label><input type="range" id="pitch" min="-45" max="45" value="0">
    <label>Roll</label><input type="range" id="roll" min="-45" max="45" value="0">
    <label>ズーム</label><input type="range" id="zoom" min="0.5" max="2.0" value="1" step="0.01">
  </div>

  <div class="canvasWrap" id="stageWrap">
    <div class="hud" id="stageHud">
      <button class="btn" id="anglePrev">◀角度</button>
      <button class="btn" id="angleNext">角度▶</button>
      <span class="badge" id="angleInfo">角度: 0°</span>
    </div>
    <video id="video" playsinline class="hidden"></video>
    <canvas id="stage" class="img"></canvas>
    <canvas id="heat" class="img"></canvas>
    <div id="guard" class="guard"></div>
    <button id="fabShot" title="撮影"></button>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="btn" id="addSofa">ソファ追加（写真）</button>
    <button class="btn" id="addTable">テーブル追加（写真）</button>
    <button class="btn" id="addPlant">観葉追加（写真）</button>
    <button class="btn" id="addCustom">家具画像（複数角度）追加</button><input type="file" id="multiInput" accept="image/*" multiple class="hidden">
  </div>
  <small>手順: カメラ起動→右下シャッター/上部「撮影」→または写真選択。<b>基準2点</b>で実寸化。家具はドラッグ/回転ハンドル/ピンチで拡縮、ダブルタップ削除。<b>角度ボタン</b>で登録角度を切替。</small>
</section>

<!-- ===== 間取り・実寸 ===== -->
<section id="measure" class="panel hidden">
  <div class="row">
    <button class="btn" id="mUseStage">ステージ画像を使う</button>
    <label>㎡単価(円)</label><input type="number" id="unitPrice" value="1200" step="100">
    <button class="btn" id="mAddRect">矩形</button>
    <button class="btn" id="mAddPoly">多角形</button>
    <button class="btn" id="mClear">クリア</button>
    <label>明るさ</label><input type="range" id="bright" min="-100" max="100" value="0">
    <label>コントラスト</label><input type="range" id="contrast" min="-100" max="100" value="0">
    <label>彩度</label><input type="range" id="saturation" min="-100" max="100" value="0">
  </div>
  <div class="canvasWrap"><canvas id="mCanvas" class="img"></canvas></div>
  <div id="mKpi" class="kpi"></div>
</section>

<!-- ===== 騒音/音響ホログラフィ ===== -->
<section id="noise" class="panel hidden">
  <div class="row" id="noiseControls">
    <button class="btn" id="micStart">マイク計測開始</button>
    <button class="btn" id="micStop">停止</button>
    <label>Yレンジ(dB)</label><input type="range" id="dbRange" min="20" max="100" value="60">
    <label>窓長(s)</label><input type="range" id="winSec" min="1" max="8" value="4">
    <label>帯域</label><select id="band"><option value="low">低</option><option value="mid" selected>中</option><option value="high">高</option></select>
    <button class="btn" id="hfScan">ホログラフィ スキャン</button>
    <button class="btn" id="hfPin">ピン留め</button>
    <button class="btn" id="hfClear">クリア</button>
  </div>
  <div class="kpi">
    <div class="chip" id="minDb">最小:-</div>
    <div class="chip" id="maxDb">最大:-</div>
    <div class="chip" id="avgDb">平均:-</div>
  </div>
  <div class="canvasWrap"><canvas id="wave" height="120"></canvas></div>
  <h4>FFTスペクトログラム（時間×周波数、色=レベル）＋ 簡易音響ホログラフィ（ヒート重畳）</h4>
  <div class="canvasWrap"><canvas id="spec" height="240"></canvas></div>
  <small>※単一マイクのため方向推定は**スキャン式**（視線中心の帯域エネルギーを地図化）です。</small>
</section>

<!-- ===== 物件/土地値比率 ===== -->
<section id="land" class="panel hidden">
  <div class="row">
    <label>物件価格(万円)</label><input type="number" id="priceM" value="1980" step="10">
    <label>土地面積(m²)</label><input type="number" id="landArea" value="100" step="0.1">
  </div>
  <div class="row">
    <button class="btn" id="gps">GPSで座標</button>
    <input id="addr" placeholder="住所（任意）" style="min-width:240px">
    <span id="latlng" class="badge">緯度: - / 経度: -</span>
  </div>
  <div class="row">
    <label>路線価(千円/m²)</label><input type="number" id="rosen" step="1">
    <label>公示価格(千円/m²)</label><input type="number" id="koji" step="1">
    <label>近傍成約(千円/m²)</label><input type="number" id="deal" step="1">
    <button class="btn" id="avg3">3点平均を計算</button>
    <button class="btn" id="autoRosen">路線価 自動取得(β)</button>
  </div>
  <div id="landKpi" class="kpi"></div>
  <small>注: 単体HTMLはCORS制約で**自動取得が失敗**する場合があります。その際は手入力してください。オンライン版はサーバ/proxyで自動化。</small>
</section>

<!-- ===== 収支/DSCR ===== -->
<section id="dscr" class="panel hidden">
  <div class="row">
    <label>月額家賃(円)</label><input type="number" id="rent" value="70000" step="1000">
    <label>稼働率</label><input type="number" id="occ" value="0.95" step="0.01">
    <label>経費率</label><input type="number" id="opex" value="0.25" step="0.01">
    <select id="agePreset">
      <option value="">築年数プリセット</option>
      <option value="0.18">～5年(0.18)</option>
      <option value="0.22">6–15年(0.22)</option>
      <option value="0.28">16–30年(0.28)</option>
      <option value="0.33">31年以上(0.33)</option>
    </select>
  </div>
  <div class="row">
    <label>固定費(年,円)</label><input type="number" id="fixed" value="120000" step="10000">
    <label>借入額(円)</label><input type="number" id="loan" value="15000000" step="100000">
    <label>金利</label><input type="number" id="rate" value="0.02" step="0.001">
    <label>返済年数</label><input type="number" id="years" value="30">
  </div>
  <div id="dscrKpi" class="kpi"></div>
</section>

<!-- ===== 内見チェック（ガイド） ===== -->
<section id="check" class="panel hidden">
  <div class="row">
    <button class="btn" id="wizardStart">ガイド開始</button>
    <button class="btn" id="addItem">表に項目追加</button>
    <select id="presetC">
      <option value="">テンプレを挿入</option>
      <option>外壁・屋根雨漏り</option><option>室内壁天井</option><option>床/床鳴り</option>
      <option>水回り(キッチン/浴室/洗面/トイレ)</option><option>建具/サッシ</option><option>電気/換気</option>
    </select>
  </div>
  <div id="wizard" class="panel hidden" style="background:#0b1730;border:1px dashed #2c3f63">
    <div id="wStep" class="kpi"></div>
    <div class="row">
      <button class="btn" id="wShot">撮影/選択</button><input id="wFile" type="file" accept="image/*,video/*" class="hidden">
      <select id="wState"><option>良</option><option>可</option><option>要修繕</option></select>
      <input id="wNote" placeholder="メモ（任意）" style="min-width:200px">
      <button class="btn" id="wNext">次へ</button>
    </div>
  </div>
  <table class="table" id="tbl">
    <thead><tr><th>項目</th><th>判定</th><th>数量</th><th>単位</th><th>単価(円)</th><th>概算</th><th>写真/動画</th></tr></thead>
    <tbody></tbody>
  </table>
  <div id="chkKpi" class="kpi"></div>
</section>

<!-- ===== 保存 ===== -->
<section id="save" class="panel hidden">
  <div class="row">
    <button class="btn good" id="saveHtml">この状態で単体HTML保存</button>
    <span class="badge">※スマホはダウンロードに同意→保存</span>
  </div>
</section>

</div>

<button id="tapFix" title="タップ復旧">タップ復旧</button>
<div id="tapEcho" class="hidden">tap debug</div>

<footer><small>© 内見ユーティリティ v8.3 — 改訂履歴・設計思想はキャンバス管理（完全版のみ出力・機能削除禁止）</small></footer>

<script>
const qs=s=>document.querySelector(s), qsa=s=>[...document.querySelectorAll(s)];
qs('#ua').textContent=navigator.userAgent;
qsa('[data-tab]').forEach(b=>b.onclick=()=>{
  const t=b.dataset.tab; qsa('section').forEach(s=>s.classList.add('hidden'));
  qs('#'+t).classList.remove('hidden');
  qsa('[data-tab]').forEach(x=>x.classList.remove('primary')); b.classList.add('primary');
});

// ===== タップ復旧（グローバル・キルスイッチ） =====
function tapFix(){
  // 透明オーバーレイの無効化
  qsa('.guard').forEach(g=>{g.classList.remove('on'); g.style.pointerEvents='none'; g.style.display='none';});
  // 動画/ヒートはクリック無効
  const v=qs('#video'); if(v){ v.style.pointerEvents='none'; }
  const heat=qs('#heat'); if(heat){ heat.style.pointerEvents='none'; }
  // 騒音ボタンを最前面
  const nc=qs('#noiseControls'); if(nc){ nc.style.zIndex=9500; }
  // 全ボタンを強制 pointer-events: auto
  qsa('button,.btn,select,input,label').forEach(el=>{ el.style.pointerEvents='auto'; el.disabled=false; el.style.opacity=1; });
}
qs('#tapFix').onclick=()=>{ tapFix(); console.log('[tapFix] applied'); };

// タップデバッグ（どの要素が拾っているか可視化）
document.addEventListener('pointerdown',e=>{
  const el=document.elementFromPoint(e.clientX,e.clientY);
  const box = qs('#tapEcho'); box.textContent = 'tap: '+(el?.tagName||'none')+(el?.id?('#'+el.id):'')+(el?.className?('.'+el.className):'');
  box.classList.remove('hidden'); setTimeout(()=>box.classList.add('hidden'),1200);
}, {passive:true});

// ===== ステージング =====
const wrap=qs('#stageWrap'), video=qs('#video'), fab=qs('#fabShot'),
      cv=qs('#stage'), ctx=cv.getContext('2d'),
      heat=qs('#heat'), hctx=heat.getContext('2d'), guard=qs('#guard');
let stream=null, baseBitmap=null, scalePPM=null, p1=null,p2=null;

// 角度管理（多角度スプライト）
let angleIdx=0; const angles=[0,15,30,45];
qs('#anglePrev').onclick=()=>{ angleIdx=(angleIdx-1+angles.length)%angles.length; qs('#angleInfo').textContent=`角度: ${angles[angleIdx]}°`; swapFurnitureAngle(); };
qs('#angleNext').onclick=()=>{ angleIdx=(angleIdx+1)%angles.length; qs('#angleInfo').textContent=`角度: ${angles[angleIdx]}°`; swapFurnitureAngle(); };
function swapFurnitureAngle(){ qsa('.furniture').forEach(el=>{ const src=el.dataset['angle'+angleIdx]; if(src) el.src=src; }); }

function fitCanvas(w,h){ const W=wrap.clientWidth, H=Math.round(h*W/w); cv.width=W; cv.height=H; heat.width=W; heat.height=H; wrap.style.height=H+'px'; }
async function drawBase(){
  if(!baseBitmap) return;
  fitCanvas(baseBitmap.width, baseBitmap.height);
  ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,cv.width,cv.height);
  const yaw=+qs('#yaw').value*Math.PI/180, pitch=+qs('#pitch').value*Math.PI/180, roll=+qs('#roll').value*Math.PI/180, zoom=+qs('#zoom').value;
  ctx.translate(cv.width/2,cv.height/2); ctx.scale(zoom,zoom); ctx.rotate(roll);
  ctx.transform(1, Math.tan(pitch)/8, Math.tan(yaw)/8, 1, 0, 0); ctx.translate(-cv.width/2,-cv.height/2);
  ctx.drawImage(baseBitmap,0,0,cv.width,cv.height);
  if(p1&&p2){ ctx.fillStyle="#ffc400"; ctx.strokeStyle="#ffc400"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke();
    ctx.beginPath(); ctx.arc(p1.x,p1.y,6,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(p2.x,p2.y,6,0,Math.PI*2); ctx.fill(); }
}

// ファイル選択（スマホ強制カメラを避ける）
qs('#pickBtn').onclick=()=>qs('#fileInput').click();
qs('#fileInput').onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  baseBitmap = await ensureBitmapFromFile(f); await drawBase(); stopCam();
};
async function ensureBitmapFromFile(file){
  if(createImageBitmap){ return await createImageBitmap(file); }
  return new Promise(res=>{ const img=new Image(); img.onload=()=>res(img); img.src=URL.createObjectURL(file); });
}

// カメラ
qs('#camStart').onclick=async()=>{
  try{
    if(stream) return;
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    video.srcObject=stream; await video.play(); video.classList.remove('hidden'); fab.style.display='block';
    const loop=async()=>{ if(!video.srcObject) return; baseBitmap=await snapshotFromVideo(); await drawBase(); requestAnimationFrame(loop); };
    loop();
  }catch(e){ alert('カメラ失敗: '+e.message); }
};
function stopCam(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } video.pause(); video.srcObject=null; video.classList.add('hidden'); fab.style.display='none'; }
function shoot(){ if(!baseBitmap){ alert('先にカメラ起動/写真選択'); return; } drawBase(); stopCam(); }
qs('#shotTop').onclick=shoot; fab.onclick=shoot;
function snapshotFromVideo(){
  const w=video.videoWidth||1280, h=video.videoHeight||720;
  const tmp=document.createElement('canvas'); tmp.width=w; tmp.height=h;
  const tctx=tmp.getContext('2d'); tctx.drawImage(video,0,0,w,h);
  return createImageBitmap? createImageBitmap(tmp) : new Promise(res=>{ const img=new Image(); img.onload=()=>res(img); img.src=tmp.toDataURL(); });
}

// 基準2点（ガードは一時ON→タイムアウト）
qs('#set2pt').onclick=()=>{
  if(!baseBitmap){alert('先に画像');return;}
  guard.classList.add('on'); p1=null;p2=null;
  const onClick=e=>{
    const r=cv.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
    if(!p1){ p1={x,y}; drawBase(); }
    else{ p2={x,y}; const pix=Math.hypot(p2.x-p1.x,p2.y-p1.y); const meter=Math.max(0.01,parseFloat(qs('#baseLen').value||'1')); scalePPM=pix/meter;
      qs('#scaleBadge').textContent=`スケール 1m ≒ ${scalePPM.toFixed(1)}px`; guard.classList.remove('on'); cv.removeEventListener('click',onClick); p1=null;p2=null; drawBase(); }
  };
  cv.addEventListener('click',onClick); setTimeout(()=>{guard.classList.remove('on'); cv.removeEventListener('click',onClick)},20000);
};

// 家具（写真スプライト：多角度）
function addFurnSet(imgs){
  const el=document.createElement('img'); el.className='furniture';
  imgs.forEach((u,i)=>el.dataset['angle'+i]=u); el.src=imgs[Math.min(angleIdx,imgs.length-1)]||imgs[0];
  let x=wrap.clientWidth*0.5, y=wrap.clientHeight*0.75, scale=1, rot=0, touches=new Map();
  function apply(){ el.style.left=x+'px'; el.style.top=y+'px'; el.style.transform=`translate(-50%,-50%) rotate(${rot}deg) scale(${scale})`; }
  const onDown=e=>{
    el.classList.add('drag'); const sx=e.clientX, sy=e.clientY, ox=x, oy=y;
    const mv=ev=>{ x=ox+(ev.clientX-sx); y=oy+(ev.clientY-sy); clamp(); apply(); };
    const up=()=>{el.classList.remove('drag'); window.removeEventListener('pointermove',mv); window.removeEventListener('pointerup',up)}
    window.addEventListener('pointermove',mv,{passive:false}); window.addEventListener('pointerup',up,{once:true});
  };
  const knob=document.createElement('div'); knob.className='knob'; el.appendChild(knob);
  knob.onpointerdown=e=>{ e.stopPropagation(); const sx=e.clientX, base=rot; const mv=ev=>{rot=base+(ev.clientX-sx)/2; apply();}; const up=()=>window.removeEventListener('pointermove',mv);
    window.addEventListener('pointermove',mv); window.addEventListener('pointerup',up,{once:true}); };
  el.addEventListener('pointerdown',e=>touches.set(e.pointerId,{x:e.clientX,y:e.clientY}),{passive:true});
  el.addEventListener('pointermove',e=>{
    if(!touches.has(e.pointerId)) return;
    touches.set(e.pointerId,{x:e.clientX,y:e.clientY});
    if(touches.size===2){
      const [a,b]=[...touches.values()]; const d=Math.hypot(a.x-b.x,a.y-b.y);
      if(!el._d0){ el._d0=d; el._s0=scale; }
      scale=Math.max(.2, Math.min(4, el._s0 * (d/el._d0))); apply();
    }
  },{passive:true});
  el.addEventListener('pointerup',e=>{touches.delete(e.pointerId); if(touches.size<2){ el._d0=null; }},{passive:true});
  el.addEventListener('pointercancel',e=>touches.delete(e.pointerId));
  el.addEventListener('pointerdown',onDown);
  let last=0; el.addEventListener('click',e=>{const t=Date.now(); if(t-last<300){ el.remove(); } last=t;});
  function clamp(){ const m=20,W=wrap.clientWidth,H=wrap.clientHeight; x=Math.max(m,Math.min(W-m,x)); y=Math.max(m,Math.min(H-m,y)); }
  wrap.appendChild(el); apply();
}
function dataUrlPlaceholder(color="#666"){
  const c=document.createElement('canvas'); c.width=512; c.height=320; const x=c.getContext('2d');
  x.fillStyle=color; x.fillRect(0,0,c.width,c.height); x.fillStyle="#fff"; x.font="bold 26px system-ui"; x.fillText("家具（写真素材）",120,170);
  return c.toDataURL("image/jpeg",0.9);
}
qs('#addSofa').onclick=()=>addFurnSet([dataUrlPlaceholder("#576"),dataUrlPlaceholder("#686"),dataUrlPlaceholder("#798"),dataUrlPlaceholder("#8a9")]);
qs('#addTable').onclick=()=>addFurnSet([dataUrlPlaceholder("#8