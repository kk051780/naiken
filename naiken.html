<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>内見ツール（ステージング/計測/騒音/収支/チェック）STFT版</title>
  <style>
    :root{--bg:#0e1a2a;--panel:#0f2238;--btn:#123e66;--btn2:#1f6feb;--text:#e6eef9;--muted:#9fb3c8;}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;}
    header{padding:12px 12px 4px;font-weight:700;font-size:18px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px;background:var(--panel);position:sticky;top:0;z-index:20}
    .tab{padding:10px 14px;border-radius:14px;background:#12273e;cursor:pointer;user-select:none}
    .tab.active{background:var(--btn2)}
    section{display:none;padding:12px}
    section.active{display:block}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    .btn{background:var(--btn);padding:10px 12px;border-radius:12px;border:none;color:var(--text);cursor:pointer}
    .btn.primary{background:var(--btn2)} .btn:disabled{opacity:.5}
    .field{background:#0b1a2a;border-radius:10px;padding:8px 10px;display:flex;align-items:center;gap:8px}
    input[type="number"],input[type="text"],select{background:#0b1a2a;border:1px solid #284a70;color:var(--text);border-radius:8px;padding:10px;min-width:110px}
    label{color:var(--muted);font-size:12px}
    canvas,video{max-width:100%;border-radius:10px;background:#000}
    #stageWrap{position:relative;max-width:100%}
    #bgCanvas{display:block;width:100%}
    .sprite{position:absolute;border:2px solid rgba(255,255,255,.7);border-radius:8px;padding:6px 10px;background:rgba(20,20,20,.28);backdrop-filter: blur(2px);color:#fff;cursor:move;user-select:none;z-index:12}
    .sprite::after{content:attr(data-label);font-weight:600}
    .tag{border-radius:999px;padding:4px 10px;background:#10273f;color:#9fb3c8;font-size:12px}
    .grid{width:100%;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #223b59;padding:8px;text-align:left}
    .pill{padding:4px 10px;border-radius:999px}
    .ok{background:#0a6c3a}.ng{background:#7a1b2a}
    .hint{font-size:12px;color:#9fb3c8}
    .chart{height:180px;background:#06121f;border-radius:8px}
    .small{font-size:12px}
    .clickOverlay{position:absolute;left:0;top:0;width:100%;height:100%;z-index:15;pointer-events:auto;cursor:crosshair;border-radius:10px}
    #measureWrap{position:relative;display:inline-block}
  </style>
</head>
<body>
  <header>不動産 内見ツール（カメラ/ステージング/計測/騒音/収支/チェック）</header>

  <div class="tabs">
    <div class="tab active" data-tab="t_stage">ステージング</div>
    <div class="tab" data-tab="t_noise">騒音</div>
    <div class="tab" data-tab="t_measure">間取り・実寸</div>
    <div class="tab" data-tab="t_lands">物件情報/土地値比率</div>
    <div class="tab" data-tab="t_dscr">収支/DSCR</div>
    <div class="tab" data-tab="t_check">チェック</div>
    <div class="tab" data-tab="t_save">保存/レポート</div>
  </div>

  <!-- ステージング（省略：前版と同じ） -->
  <section id="t_stage" class="active">
    <div class="row">
      <button id="btnStartCam" class="btn">カメラ起動</button>
      <button id="btnShot" class="btn">撮影</button>
      <label class="btn"><input id="filePick" type="file" accept="image/*" style="display:none">写真を選ぶ</label>
      <button id="btnResetSprites" class="btn">家具リセット</button>
      <button id="btnAuto" class="btn primary">自動配置</button>
    </div>
    <div class="row">
      <button id="btnTwoPt" class="btn">基準2点</button>
      <div class="field"><label>基準長さ(m)</label><input id="baseLen" type="number" step="0.01" value="2.0"></div>
      <div class="field"><span class="tag" id="scaleTag">スケール未設定</span></div>
      <div class="field"><label>スタイル</label>
        <select id="styleSelect">
          <option value="single-minimal">単身男性 / ミニマル</option>
          <option value="natural">ナチュラル</option>
          <option value="modern">モダン</option>
          <option value="family">ファミリー</option>
        </select>
      </div>
    </div>
    <div id="stageWrap">
      <video id="video" playsinline autoplay muted style="display:none"></video>
      <canvas id="bgCanvas" width="720" height="480"></canvas>
      <div id="twoPtOverlay" class="clickOverlay" style="display:none"></div>
    </div>
    <div class="row"><label class="hint">撮影/写真選択 → 基準2点 → 自動配置 → ドラッグで調整</label></div>
  </section>

  <!-- 騒音：時間FFTスペクトログラム -->
  <section id="t_noise">
    <div class="row">
      <button id="btnMic" class="btn">マイク開始</button>
      <button id="btnMicStop" class="btn">停止</button>
      <div class="field"><span id="dbNow">-- dB</span></div>
      <div class="field"><span id="laeq">LAeq: --</span></div>
      <div class="field small">濃いほど騒音レベルが高い（dB）</div>
    </div>

    <!-- LAeq 時系列 -->
    <canvas id="dbCanvas" class="chart" width="900" height="160"></canvas>

    <!-- スペクトログラム（x=時間, y=周波数, 濃さ=レベル） -->
    <div style="position:relative; width:100%; max-width:900px; margin-top:8px;">
      <canvas id="specCanvas" class="chart" width="900" height="240"></canvas>
      <canvas id="specAxis" width="900" height="240"
        style="position:absolute; left:0; top:0; pointer-events:none;"></canvas>
    </div>
    <div class="small hint">縦目盛：50Hz / 100 / 200 / 500 / 1k / 2k / 5k / 10k / 16kHz、横＝時間（右が最新）。</div>
  </section>

  <!-- 計測 / 土地値比率 / DSCR / チェック / 保存（前版と同じなので省略） -->
  <section id="t_measure"><div class="hint">※前版と同じ。必要なら送ります。</div></section>
  <section id="t_lands"><div class="hint">※前版と同じ。必要なら送ります。</div></section>
  <section id="t_dscr"><div class="hint">※前版と同じ。必要なら送ります。</div></section>
  <section id="t_check"><div class="hint">※前版と同じ。必要なら送ります。</div></section>
  <section id="t_save"><div class="hint">※前版と同じ。必要なら送ります。</div></section>

<script>
const $=(q)=>document.querySelector(q), $$=(q)=>Array.from(document.querySelectorAll(q));
$$('.tab').forEach(t=>t.onclick=()=>{$$('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');$$('section').forEach(s=>s.classList.remove('active'));$('#'+t.dataset.tab).classList.add('active');});

// ---------------- ステージング（簡略） ----------------
const bg=$('#bgCanvas'), g=bg.getContext('2d'), video=$('#video');
let stream=null, scalePxPerM=null;
async function startCam(){ try{ stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false}); video.srcObject=stream; video.style.display='block'; requestAnimationFrame(drawVideo);}catch(e){ alert('カメラ起動に失敗: '+e); } }
function drawVideo(){ if(video.style.display!=='none'){ g.drawImage(video,0,0,bg.width,bg.height); requestAnimationFrame(drawVideo);} }
$('#btnStartCam').onclick=startCam;
$('#btnShot').onclick=()=>{ if(!stream) return; video.style.display='none'; g.drawImage(video,0,0,bg.width,bg.height); }
$('#filePick').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const url=URL.createObjectURL(f); const img=new Image(); img.onload=()=>{ g.clearRect(0,0,bg.width,bg.height); const r=Math.min(bg.width/img.width,bg.height/img.height); const w=img.width*r,h=img.height*r; g.drawImage(img,(bg.width-w)/2,(bg.height-h)/2,w,h); }; img.src=url; };

// ---------------- 騒音：LAeq + STFT ----------------
let audioCtx, analyser, timeBuf, rafId;
const dbCanvas = $('#dbCanvas'), dbCtx = dbCanvas.getContext('2d');
const specCanvas = $('#specCanvas'), spCtx = specCanvas.getContext('2d');
const axisCtx = $('#specAxis').getContext('2d');
let lastSpecTime = 0, specFPS = 20; // ≒1列=0.05秒

async function startMic(){
  try{
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const src=audioCtx.createMediaStreamSource(s);
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=2048;                 // 周波数解像度↑（=Fs/fftSize）
    analyser.minDecibels=-90;              // dBレンジ
    analyser.maxDecibels=-10;
    analyser.smoothingTimeConstant=0.8;    // 時間方向の平滑
    src.connect(analyser);
    timeBuf=new Uint8Array(analyser.fftSize);
    spCtx.fillStyle = '#000'; spCtx.fillRect(0,0,specCanvas.width,specCanvas.height);
    drawSpecAxes();
    loop();
  }catch(e){ alert('マイク開始に失敗: '+e); }
}
$('#btnMic').onclick=startMic;
$('#btnMicStop').onclick=()=>cancelAnimationFrame(rafId);

// 軸（周波数目盛）
function drawSpecAxes(){
  axisCtx.clearRect(0,0,axisCtx.canvas.width,axisCtx.canvas.height);
  const H=axisCtx.canvas.height, W=axisCtx.canvas.width;
  axisCtx.font='10px system-ui';
  axisCtx.fillStyle='rgba(255,255,255,.85)';
  axisCtx.strokeStyle='rgba(255,255,255,.18)';
  const ticks=[50,100,200,500,1000,2000,5000,10000,16000];
  const binCount = analyser.frequencyBinCount; // = fftSize/2
  const fs = audioCtx.sampleRate;

  ticks.forEach(f=>{
    let bin = Math.round(f * analyser.fftSize / fs);
    if (bin < 0) bin=0;
    if (bin > binCount-1) bin = binCount-1;
    const y = H - Math.round(bin * H / binCount);
    axisCtx.beginPath(); axisCtx.moveTo(0,y); axisCtx.lineTo(W,y); axisCtx.stroke();
    axisCtx.fillText(f>=1000? (f/1000)+'kHz' : f+'Hz', 6, Math.max(10,y-2));
  });
  axisCtx.fillText('時間 →（右が最新）', W-130, H-6);
}

// LAeq（簡易・参考値）
let laeqBuf=[];
function drawLAeq(dbA){
  laeqBuf.push(dbA); if(laeqBuf.length>dbCanvas.width) laeqBuf.shift();
  const laeq=laeqBuf.reduce((a,b)=>a+b,0)/laeqBuf.length;
  $('#dbNow').textContent=dbA.toFixed(1)+' dB'; $('#laeq').textContent='LAeq: '+laeq.toFixed(1);

  dbCtx.fillStyle='#06121f'; dbCtx.fillRect(0,0,dbCanvas.width,dbCanvas.height);
  dbCtx.strokeStyle='#7fb3ff'; dbCtx.beginPath();
  laeqBuf.forEach((v,i)=>{
    const x=i, y=dbCanvas.height-(v/120)*dbCanvas.height;
    i?dbCtx.lineTo(x,y):dbCtx.moveTo(x,y);
  });
  dbCtx.stroke();
}

// スペクトログラム1列を右端に追加（高レベルほど濃い＝黒寄り）
function pushSpecColumn(){
  const freqDb = new Float32Array(analyser.frequencyBinCount);
  analyser.getFloatFrequencyData(freqDb); // dB 値（負～0 付近）

  // 既存を左に1pxスクロール
  spCtx.drawImage(specCanvas, -1, 0);

  // 新列（幅1px）を作成
  const H = specCanvas.height;
  const img = spCtx.createImageData(1, H);
  for(let y=0;y<H;y++){
    // 下（低周波）→上（高周波）になるように反転
    const bin = Math.round( (H-1-y) * freqDb.length / H );
    const vDb = freqDb[Math.max(0, Math.min(freqDb.length-1, bin))];
    // 正規化（min→0, max→1）
    const t = Math.min(1, Math.max(0, (vDb - analyser.minDecibels)/(analyser.maxDecibels - analyser.minDecibels)));
    // 濃淡（大きいほど濃い＝暗く）: 0(白)～1(黒)
    const gray = Math.round((1 - t) * 255);
    const i = y*4; img.data[i]=gray; img.data[i+1]=gray; img.data[i+2]=gray; img.data[i+3]=255;
  }
  spCtx.putImageData(img, specCanvas.width-1, 0);
}

function loop(t=0){
  // LAeq用：時間波形RMS→dB→簡易A特性補正（-2dB）
  analyser.getByteTimeDomainData(timeBuf);
  let sum=0; for(let i=0;i<timeBuf.length;i++){ const v=(timeBuf[i]-128)/128; sum+=v*v; }
  const rms=Math.sqrt(sum/timeBuf.length);
  const db = 20*Math.log10(rms+1e-9)+100;
  drawLAeq(db-2);

  // スペクトログラム：20FPSで列追加
  if(!lastSpecTime || (t-lastSpecTime) >= 1000/specFPS){
    pushSpecColumn();
    lastSpecTime = t;
  }
  rafId=requestAnimationFrame(loop);
}
</script>
</body>
</html>